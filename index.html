<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>单词拼写闯关游戏</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f8ff;
      padding: 20px;
      text-align: center;
    }
    #game-container {
      max-width: 600px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #333;
    }
    .letter-input, .fixed-letter {
      width: 30px;
      height: 36px;
      font-size: 20px;
      margin: 3px;
      text-align: center;
      border: none;
      border-bottom: 2px solid #000;
      background: transparent;
    }
    .letter-input.correct {
      animation: pop 0.3s ease;
    }
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    .letter-box {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background-color: #45a049;
    }
    #result {
      margin-top: 15px;
      font-weight: bold;
    }
    .option-btn {
      display: block;
      margin: 6px auto;
      width: 80%;
    }
    #definition {
      margin: 10px;
      font-size: 16px;
      color: #4CAF50; 
    }
    #phonetic {
      margin: 10px;
      font-size: 16px;
      color: #2196F3;
    }
    #stats {
      margin-top: 15px;
      font-size: 14px;
      color: #666;
    }
    audio {
      display: none;
    }
    .streak-effect {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 32px;
      font-weight: bold;
      color: #ff9800;
      opacity: 0;
      animation: streak 1s forwards;
      pointer-events: none;
    }
    @keyframes streak {
      0% { opacity: 0; transform: translate(-50%, -20px); }
      50% { opacity: 1; transform: translate(-50%, 0); }
      100% { opacity: 0; transform: translate(-50%, 20px); }
    }
    .listening {
      background-color: #f44336 !important; /* 红色表示正在监听 */
    }
    .reset-btn {
      background-color: #2196F3;
    }
    .review-btn {
      background-color: #9C27B0;
    }
    .audio-error {
      color: #f44336;
      font-size: 14px;
      margin-top: 5px;
    }
    .file-notification {
      color: #2196F3;
      font-size: 14px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
<div id="game-container">
  <h1>单词拼写闯关游戏</h1>
  <audio id="bgm" autoplay loop>
    <source src="https://cdn.pixabay.com/audio/2022/10/30/audio_46fdd201cc.mp3" type="audio/mpeg">
  </audio>
  <audio id="correct-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_e0b6f67a53.mp3"></audio>
  <audio id="wrong-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_2307f9b816.mp3"></audio>
  <audio id="word-audio" onerror="handleAudioError()"></audio>
  
  <!-- 文件选择区域 -->
  <div id="fileSelector" style="margin-bottom: 15px;">
    <label>选择单词文件：</label>
    <select id="wordFileSelect" onchange="loadSelectedWordFile()">
      <option value="default">默认单词库</option>
    </select>
    <button onclick="deleteCurrentFile()" id="deleteFileBtn" style="background-color: #f44336;">删除文件进度</button>
    <div id="fileNotification" class="file-notification"></div>
  </div>
  
  <div id="content">
    <div id="instruction"></div>
    <div id="definition"></div>
    <div id="phonetic"></div>
    <div id="question"></div>
    <div class="letter-box" id="letterBox"></div>
    <div id="audio-error" class="audio-error"></div>
    <div class="navigation-buttons">
      <button onclick="prevQuestion()" id="prevBtn">上一题</button>
      <button onclick="toggleListening()" id="startReadingBtn" style="display:none">开始朗读</button>
      <button onclick="submitAnswer()" id="nextBtn">跳过此题</button>
      <button onclick="playWord()">🔊 听单词</button>
      <button onclick="resetProgress()" class="reset-btn">重置进度</button>
      <button onclick="exitReview()" class="review-btn" style="display:none">返回闯关</button>
      <button onclick="showMistakes()" class="review-btn">📖 查看错题本</button>
    </div>
    <div id="options"></div>
    <div id="result"></div>
    <div id="stats"></div>
  </div>
</div>
<script>
  // 原始单词列表（包含音标）
  const defaultWordList = [
    {word:"morning", definition:"早晨；上午", phonetic:"/ˈmɔːnɪŋ/"},
    {word:"afternoon", definition:"午后；下午", phonetic:"/ˌɑːftəˈnuːn/"},
    {word:"evening", definition:"晚上；傍晚", phonetic:"/ˈiːvnɪŋ/"},
    {word:"night", definition:"夜间；夜晚", phonetic:"/naɪt/"},
    {word:"fine", definition:"好的", phonetic:"/faɪn/"},
    {word:"thank", definition:"感谢", phonetic:"/θæŋk/"},
    {word:"goodbye", definition:"再见", phonetic:"/ˌɡʊdˈbaɪ/"},
    {word:"woof", definition:"狗叫声", phonetic:"/wʊf/"},
    {word:"Mrs", definition:"夫人；太太", phonetic:"/ˈmɪsɪz/"},
    {word:"day", definition:"一天", phonetic:"/deɪ/"},
    {word:"today", definition:"今天", phonetic:"/təˈdeɪ/"},
  ];

  const puzzleQuestions = [
    { question: "“日出大米”猜一个字？", options: ["明", "昌", "早", "亮"], answer: "昌" },
    { question: "什么东西人们都不喜欢吃？", options: ["糖", "亏", "饼干", "巧克力"], answer: "亏" },
    { question: "什么东西越洗越脏？", options: ["衣服", "手", "水", "地板"], answer: "水" },
    { question: "什么东西越生气，它就越大？", options: ["脾气", "气球", "火气", "怒火"], answer: "脾气" },
    { question: "冬瓜、黄瓜、西瓜、南瓜都能吃，什么瓜不能吃？", options: ["傻瓜", "苦瓜", "丝瓜", "甜瓜"], answer: "傻瓜" },
  ];

  // 多文件支持 - 预定义的单词库文件名
  const predefinedWordFiles = [
    {id: "two", name: "二年级单词", filename: "two_words.txt"},
    {id: "basic", name: "新概念1词库", filename: "basic_words.txt"},
  ];

  // 单词文件存储
  let wordFiles = {
    "default": { name: "默认单词库", words: defaultWordList, isCustom: false }
  };
  let currentFile = "default";

  // 游戏变量 - 从本地存储加载或初始化
  let gameData = JSON.parse(localStorage.getItem('wordGameData')) || {
    currentIndex: 0,
    level: 0,
    correctCount: 0,
    wrongList: [],
    levelStars: [],
    puzzleQuestionsUsed: []
  };

  // 同步变量到内存
  let currentIndex = gameData.currentIndex;
  let level = gameData.level;
  let inPuzzle = false;
  let correctCount = gameData.correctCount;
  let wrongList = gameData.wrongList;
  let isReviewMode = false;
  let currentStreak = 0;
  let levelStars = gameData.levelStars;
  let currentReviewIndex = 0;
  let levelCorrect = 0;
  let recognition; // 语音识别对象
  let isListening = false; // 跟踪语音识别状态

  // 音频缓存
  const audioCache = {};

  // 标记已使用的谜题
  puzzleQuestions.forEach(q => {
    if (gameData.puzzleQuestionsUsed.includes(puzzleQuestions.indexOf(q))) {
      q.used = true;
    }
  });

  const instructionEl = document.getElementById("instruction");
  const questionEl = document.getElementById("question");
  const resultEl = document.getElementById("result");
  const optionsEl = document.getElementById("options");
  const definitionEl = document.getElementById("definition");
  const phoneticEl = document.getElementById("phonetic");
  const letterBox = document.getElementById("letterBox");
  const statsEl = document.getElementById("stats");
  const nextBtn = document.getElementById("nextBtn");
  const prevBtn = document.getElementById("prevBtn");
  const startReadingBtn = document.getElementById("startReadingBtn");
  const deleteFileBtn = document.getElementById("deleteFileBtn");
  const fileNotification = document.getElementById("fileNotification");
  const wordAudio = document.getElementById("word-audio");
  const audioErrorEl = document.getElementById("audio-error");

  const correctSound = document.getElementById("correct-sound");
  const wrongSound = document.getElementById("wrong-sound");

  // 初始化文件选择器
  function initFileSelector() {
    const selectEl = document.getElementById("wordFileSelect");
    const fileProgress = JSON.parse(localStorage.getItem('wordFileProgress') || '{}');
    
    // 清空现有选项（保留默认选项）
    const defaultOption = selectEl.querySelector('option[value="default"]');
    selectEl.innerHTML = '';
    selectEl.appendChild(defaultOption);
    
    // 创建一个集合来跟踪已添加的选项值
    const addedOptions = new Set(['default']);
    
    // 添加预定义的单词库文件选项
    predefinedWordFiles.forEach(file => {
      // 检查文件是否已加载过
      if (!wordFiles[file.id]) {
        wordFiles[file.id] = {
          name: file.name,
          filename: file.filename,
          words: [],
          isCustom: true,
          loaded: false
        };
      }
      
      // 只添加不存在的选项
      if (!addedOptions.has(file.id)) {
        const option = document.createElement("option");
        option.value = file.id;
        option.textContent = file.name;
        selectEl.appendChild(option);
        addedOptions.add(file.id);
      }
    });
    
    // 从本地存储加载自定义文件进度
    const savedFiles = JSON.parse(localStorage.getItem('customWordFiles') || '{}');
    Object.keys(savedFiles).forEach(key => {
      if (!addedOptions.has(key)) {
        const option = document.createElement("option");
        option.value = key;
        option.textContent = savedFiles[key].name;
        selectEl.appendChild(option);
        addedOptions.add(key);
      }
    });
    
    // 恢复当前选中的文件
    selectEl.value = currentFile;
    
    // 更新删除按钮状态
    updateDeleteButton();
  }

  // 更新删除按钮状态
  function updateDeleteButton() {
    deleteFileBtn.disabled = currentFile === "default";
    deleteFileBtn.style.display = currentFile === "default" ? "none" : "inline-block";
  }

  // 加载选中的单词文件
  function loadSelectedWordFile() {
    const selectedFile = document.getElementById("wordFileSelect").value;
    if (selectedFile && wordFiles[selectedFile] && selectedFile !== currentFile) {
      // 保存当前文件的进度
      saveCurrentFileProgress();
      
      // 切换到选中文件
      currentFile = selectedFile;
      fileNotification.textContent = "";
      
      // 检查文件是否需要加载
      const file = wordFiles[currentFile];
      if (!file.loaded && file.filename) {
        loadWordFileFromServer(file);
        return;
      }
      
      // 加载文件进度
      loadFileProgress();
      isReviewMode = false;
      
      // 更新删除按钮状态
      updateDeleteButton();
      
      loadNext();
    }
  }

  // 从服务器/本地加载单词文件
  function loadWordFileFromServer(file) {
    fileNotification.textContent = `正在加载 ${file.name}...`;
    
    // 创建一个新的XMLHttpRequest
    const xhr = new XMLHttpRequest();
    xhr.open('GET', file.filename, true);
    
    xhr.onload = function() {
      if (xhr.status === 200) {
        try {
          // 解析TXT文件内容（每行一个单词和释义，用逗号分隔）
          const content = xhr.responseText;
          const words = [];
          const lines = content.split('\n');
          
          lines.forEach(line => {
            if (line.trim()) {
              const [word, definition, phonetic] = line.split(',');
              if (word && definition) {
                words.push({ 
                  word: word.trim(), 
                  definition: definition.trim(),
                  phonetic: phonetic ? phonetic.trim() : '无音标'
                });
              }
            }
          });
          
          if (words.length > 0) {
            // 更新单词文件数据
            file.words = words;
            file.loaded = true;
            
            // 保存到本地存储
            const savedFiles = JSON.parse(localStorage.getItem('customWordFiles') || '{}');
            savedFiles[file.id] = {
              name: file.name,
              filename: file.filename,
              words: words,
              isCustom: true,
              loaded: true
            };
            localStorage.setItem('customWordFiles', JSON.stringify(savedFiles));
            
            fileNotification.textContent = `${file.name} 加载成功！共 ${words.length} 个单词。`;
            
            // 加载文件进度
            loadFileProgress();
            isReviewMode = false;
            
            // 更新删除按钮状态
            updateDeleteButton();
            
            loadNext();
          } else {
            fileNotification.textContent = `错误：${file.name} 格式不正确，请确保每行包含一个单词和释义，用逗号分隔。`;
          }
        } catch (error) {
          console.error("解析文件错误:", error);
          fileNotification.textContent = `错误：无法解析 ${file.name}，请检查文件格式。`;
        }
      } else if (xhr.status === 404) {
        fileNotification.textContent = `错误：未找到 ${file.name}（${file.filename}）`;
      } else {
        fileNotification.textContent = `错误：加载 ${file.name} 失败，状态码: ${xhr.status}`;
      }
    }
    
    xhr.onerror = function() {
      fileNotification.textContent = `错误：加载 ${file.name} 失败，请检查网络连接。`;
    }
    
    xhr.send();
  }

  // 保存当前文件的进度
  function saveCurrentFileProgress() {
    const progressData = JSON.parse(localStorage.getItem('wordFileProgress') || '{}');
    progressData[currentFile] = {
      currentIndex,
      level,
      correctCount,
      wrongList,
      levelStars,
      puzzleQuestionsUsed: puzzleQuestions
        .map((q, i) => q.used ? i : null)
        .filter(i => i !== null)
    };
    localStorage.setItem('wordFileProgress', JSON.stringify(progressData));
  }

  // 加载文件的进度
  function loadFileProgress() {
    const progressData = JSON.parse(localStorage.getItem('wordFileProgress') || '{}');
    const fileProgress = progressData[currentFile] || {};
    
    // 应用文件特定的进度数据
    currentIndex = fileProgress.currentIndex || 0;
    level = fileProgress.level || 0;
    correctCount = fileProgress.correctCount || 0;
    wrongList = fileProgress.wrongList || [];
    levelStars = fileProgress.levelStars || [];
    
    if (fileProgress.puzzleQuestionsUsed) {
      puzzleQuestions.forEach((q, i) => {
        q.used = fileProgress.puzzleQuestionsUsed.includes(i);
      });
    }
  }

  // 页面关闭或刷新时保存进度
  window.addEventListener('beforeunload', function() {
    saveCurrentFileProgress();
  });

  // 删除当前文件的进度数据
  function deleteCurrentFile() {
    if (currentFile === "default") {
      alert("默认单词库不能删除");
      return;
    }
    
    if (confirm(`确定要删除"${wordFiles[currentFile].name}"的进度数据吗？`)) {
      // 删除进度数据
      const progressData = JSON.parse(localStorage.getItem('wordFileProgress') || '{}');
      delete progressData[currentFile];
      localStorage.setItem('wordFileProgress', JSON.stringify(progressData));
      
      // 重新加载进度
      loadFileProgress();
      isReviewMode = false;
      
      loadNext();
    }
  }

  // 保存游戏进度到本地存储
  function saveProgress() {
    // 更新游戏数据
    gameData.currentIndex = currentIndex;
    gameData.level = level;
    gameData.correctCount = correctCount;
    gameData.wrongList = wrongList;
    gameData.levelStars = levelStars;
    gameData.puzzleQuestionsUsed = puzzleQuestions
      .map((q, i) => q.used ? i : null)
      .filter(i => i !== null);
    
    // 保存到当前文件的进度中
    saveCurrentFileProgress();
  }

  function updateStats() {
    const currentWords = wordFiles[currentFile].words;
    statsEl.textContent = `正确：${correctCount}  错误：${wrongList.length}  进度：${currentIndex + 1} / ${currentWords.length}`;
  }

  function loadNext() {
    resultEl.textContent = "";
    optionsEl.innerHTML = "";
    letterBox.innerHTML = "";
    audioErrorEl.textContent = "";
    updateStats();
    startReadingBtn.style.display = "none";
    // 重置语音识别状态
    isListening = false;
    startReadingBtn.textContent = "开始朗读";
    startReadingBtn.classList.remove("listening");
    
    // 确保跳过按钮始终显示
    nextBtn.style.display = "inline-block";
    nextBtn.disabled = false;
    nextBtn.textContent = isReviewMode ? "下一个错题" : "跳过此题";
    
    // 更新上一题按钮状态
    if (isReviewMode) {
      prevBtn.disabled = currentReviewIndex <= 0;
    } else {
      prevBtn.disabled = currentIndex <= 0;
    }

    // 错题回顾模式
    if (isReviewMode) {
      document.querySelector('button[onclick="exitReview()"]').style.display = "inline-block";
      // 空错题本的提示
      if (wrongList.length === 0) {
        instructionEl.textContent = "🎉 恭喜你攻克了所有错题！";
        definitionEl.textContent = "继续加油哦！";
        phoneticEl.textContent = "";
        questionEl.textContent = "";
        nextBtn.style.display = "none";
        prevBtn.style.display = "none";
        return;
      }
      // 确保索引在有效范围内
      if (currentReviewIndex >= wrongList.length) {
        currentReviewIndex = 0;
      }
      const wordObj = wrongList[currentReviewIndex];
      instructionEl.textContent = `错题回顾 第 ${currentReviewIndex + 1}/${wrongList.length} 题`;
      definitionEl.textContent = `中文提示：${wordObj.definition}`;
      phoneticEl.textContent = `音标：${wordObj.phonetic || '无'}`;
      questionEl.textContent = "请补全单词：";
      
      // 生成输入框（首字母固定）
      const first = document.createElement("input");
      first.type = "text";
      first.maxLength = 1;
      first.className = "fixed-letter";
      first.value = wordObj.word[0];
      first.readOnly = true;
      letterBox.appendChild(first);

      for (let i = 1; i < wordObj.word.length; i++) {
        const input = document.createElement("input");
        input.type = "text";
        input.maxLength = 1;
        input.className = "letter-input";
        input.dataset.index = i;
        addInputListeners(input);
        letterBox.appendChild(input);
      }
      letterBox.querySelector("input.letter-input")?.focus();
      
      // 自动播放当前单词读音
      setTimeout(() => playWord(), 500);
      return;
    }

    // 正常闯关模式
    document.querySelector('button[onclick="exitReview()"]').style.display = "none";
    const start = level * 8;
    if (currentIndex - start >= 8) {
      showPuzzle();
      return;
    }
    if (currentIndex >= wordFiles[currentFile].words.length) {
      instructionEl.textContent = "🎉 恭喜你完成所有单词！";
      definitionEl.innerHTML = `总星级：${levelStars.reduce((a, b) => a + b, 0)}/${levelStars.length * 3} ⭐`;
      phoneticEl.textContent = "";
      questionEl.textContent = "";
      nextBtn.style.display = "none";
      prevBtn.style.display = "none";
      return;
    }

    const currentWords = wordFiles[currentFile].words;
    const wordObj = currentWords[currentIndex];
    instructionEl.textContent = `第 ${level + 1} 关 第 ${currentIndex - start + 1}/${Math.min(8, currentWords.length - start)} 题`;
    definitionEl.textContent = `中文提示：${wordObj.definition}`;
    phoneticEl.textContent = `音标：${wordObj.phonetic || '无'}`;
    questionEl.textContent = "请补全单词：";

    // 生成输入框（首字母固定）
    const first = document.createElement("input");
    first.type = "text";
    first.maxLength = 1;
    first.className = "fixed-letter";
    first.value = wordObj.word[0];
    first.readOnly = true;
    letterBox.appendChild(first);

    for (let i = 1; i < wordObj.word.length; i++) {
      const input = document.createElement("input");
      input.type = "text";
      input.maxLength = 1;
      input.className = "letter-input";
      input.dataset.index = i;
      addInputListeners(input);
      letterBox.appendChild(input);
    }
    letterBox.querySelector("input.letter-input")?.focus();
    
    // 自动播放当前单词读音
    setTimeout(() => playWord(), 500);
    return;
  }

  // 上一题功能
  function prevQuestion() {
    if (isReviewMode) {
      // 复习模式：返回到上一个错题
      if (currentReviewIndex > 0) {
        currentReviewIndex--;
        loadNext();
      }
      return;
    }
    
    // 正常闯关模式：返回到上一个单词
    if (currentIndex > 0) {
      // 检查当前单词是否已被标记为错误
      const currentWords = wordFiles[currentFile].words;
      const currentWord = currentWords[currentIndex];
      const isAlreadyInWrong = wrongList.some(item => item.word === currentWord.word);
      
      // 如果是正确回答后前进的，需要调整正确计数
      if (!isAlreadyInWrong && currentStreak > 0) {
        correctCount--;
        currentStreak--;
      }
      
      currentIndex--;
      saveProgress();
      loadNext();
    }
  }

  // 检查是否所有输入框都已填满
  function checkAllFilled() {
    const inputs = letterBox.querySelectorAll("input.letter-input");
    for (let input of inputs) {
      if (!input.value) return false;
    }
    return true;
  }

  // 跳过当前题目
  function submitAnswer() {
    if (isReviewMode) {
      // 复习模式：直接跳转到下一个错题
      currentReviewIndex++;
      loadNext();
      return;
    }
    
    if (inPuzzle) {
      // 谜题模式：直接进入下一关
      level++;
      levelCorrect = 0;
      currentIndex = level * 8;
      inPuzzle = false;
      saveProgress();
      loadNext();
      return;
    }
    
    // 正常闯关模式：记录错题并跳转
    const currentWords = wordFiles[currentFile].words;
    const currentWord = currentWords[currentIndex];
    // 避免重复添加同一错题
    const isAlreadyInWrong = wrongList.some(item => item.word === currentWord.word);
    if (!isAlreadyInWrong) {
      wrongList.push(currentWord);
    }
    
    currentStreak = 0;
    currentIndex++;
    saveProgress();
    loadNext();
  }

  // 自动检查答案
  function autoCheckAnswer() {
    if (!checkAllFilled()) return;
    
    const currentWords = wordFiles[currentFile].words;
    const wordObj = isReviewMode 
      ? wrongList[currentReviewIndex] 
      : currentWords[currentIndex];
    
    const inputs = letterBox.querySelectorAll("input.letter-input");
    let filled = "";
    inputs.forEach(input => filled += input.value || "");
    const userAns = (wordObj.word[0] + filled).toLowerCase();

    if (userAns === wordObj.word.toLowerCase()) {
      resultEl.textContent = "✅ 拼写正确！请点击开始朗读";
      correctSound.play();
      startReadingBtn.style.display = "inline-block";
    } else {
      resultEl.textContent = "❌ 拼写错误，请重新填写";
      wrongSound.play();
      // 清空输入框
      inputs.forEach(input => {
        input.value = "";
      });
      letterBox.querySelector("input.letter-input")?.focus();
    }
  }

  // 初始化语音识别
  function initRecognition() {
    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript.trim().toLowerCase();
        processRecognitionResult(transcript);
      };
      
      recognition.onend = function() {
        // 识别结束后重置按钮状态
        isListening = false;
        startReadingBtn.textContent = "开始朗读";
        startReadingBtn.classList.remove("listening");
      };
      
      recognition.onerror = function(event) {
        console.error('语音识别错误:', event.error);
        resultEl.textContent = "语音识别出错，请重试";
        // 错误时重置按钮状态
        isListening = false;
        startReadingBtn.textContent = "开始朗读";
        startReadingBtn.classList.remove("listening");
      };
    } else {
      resultEl.textContent = "抱歉，您的浏览器不支持语音识别功能";
      startReadingBtn.disabled = true;
    }
  }

  /**
   * 增强版语音识别处理 - 支持模糊匹配
   * 1. 计算字符串编辑距离（Levenshtein距离）
   * 2. 根据单词长度动态设置容错阈值
   * 3. 处理常见发音变体（复数、时态等）
   */
  function processRecognitionResult(transcript) {
    const currentWords = wordFiles[currentFile].words;
    const wordObj = isReviewMode 
      ? wrongList[currentReviewIndex] 
      : currentWords[currentIndex];
    
    const target = wordObj.word.toLowerCase();
    // 预处理识别结果（去除常见冗余词汇）
    let cleanTranscript = transcript
      .replace(/^(the |a |an )/, '')  // 去除冠词
      .replace(/\s+/g, '');           // 去除空格
    
    // 处理复数和时态变化
    const singularTranscript = cleanTranscript.replace(/s$/, '');
    const singularTarget = target.replace(/s$/, '');
    const pastTranscript = cleanTranscript.replace(/ed$/, '');
    const pastTarget = target.replace(/ed$/, '');
    
    // 计算编辑距离（Levenshtein算法）
    const distance = levenshteinDistance(cleanTranscript, target);
    const singularDistance = levenshteinDistance(singularTranscript, singularTarget);
    const pastDistance = levenshteinDistance(pastTranscript, pastTarget);
    
    // 取最小距离
    const minDistance = Math.min(distance, singularDistance, pastDistance);
    
    // 根据单词长度动态设置阈值
    const threshold = target.length <= 4 ? 1 : 2;
    
    // 判断是否匹配成功
    if (minDistance <= threshold) {
      resultEl.textContent = `✅ 朗读正确！（系统识别："${transcript}"）`;
      correctSound.play();
      
      // 延迟一段时间后自动进入下一题
      setTimeout(() => {
        if (isReviewMode) {
          // 复习模式：从错题本中删除当前做对的题目
          wrongList.splice(currentReviewIndex, 1);
          loadNext();
        } else {
          correctCount++;
          currentStreak++;
          levelCorrect++;
          currentIndex++;
          saveProgress();
          loadNext();
        }
      }, 1000);
    } else {
      resultEl.textContent = `❌ 再试试！（系统识别："${transcript}"）`;
      wrongSound.play();
    }
  }

  /**
   * 计算两个字符串的编辑距离（Levenshtein距离）
   * 用于衡量两个字符串的相似度
   */
  function levenshteinDistance(s, t) {
    if (s === t) return 0;
    if (s.length === 0) return t.length;
    if (t.length === 0) return s.length;

    const v0 = new Array(t.length + 1);
    const v1 = new Array(t.length + 1);

    for (let i = 0; i < v0.length; i++) v0[i] = i;
    for (let i = 0; i < s.length; i++) {
      v1[0] = i + 1;
      for (let j = 0; j < t.length; j++) {
        const cost = (s[i] === t[j]) ? 0 : 1;
        v1[j + 1] = Math.min(
          v1[j] + 1,         // 插入
          v0[j + 1] + 1,     // 删除
          v0[j] + cost       // 替换
        );
      }
      [v0, v1] = [v1, v0];  // 交换数组
    }
    return v0[t.length];
  }

  // 切换语音识别状态（开始/结束）
  function toggleListening() {
    if (!recognition) {
      initRecognition();
    }
    
    if (isListening) {
      // 停止语音识别
      window.speechSynthesis.cancel();
      recognition.stop();
      isListening = false;
      startReadingBtn.textContent = "开始朗读";
      startReadingBtn.classList.remove("listening");
      resultEl.textContent = "朗读已停止，请重新点击开始朗读";
    } else {
      // 开始语音识别
      try {
        recognition.start();
        isListening = true;
        startReadingBtn.textContent = "正在聆听...";
        startReadingBtn.classList.add("listening");
        resultEl.textContent = "请朗读单词...";
      } catch (e) {
        resultEl.textContent = "无法启动语音识别，请重试";
        console.error('启动语音识别失败:', e);
      }
    }
  }

  /**
   * 使用dictionaryapi.dev提供的真人发音
   * 1. 优先加载dictionaryapi.dev音频
   * 2. 实现音频缓存功能，避免重复请求
   * 3. 加载失败时自动回退到浏览器语音合成
   */
  function playWord() {
    const currentWords = wordFiles[currentFile].words;
    const wordObj = isReviewMode 
      ? wrongList[currentReviewIndex] 
      : currentWords[currentIndex];
      
    const word = wordObj?.word;
    if (!word) return;
    
    // 重置错误提示
    audioErrorEl.textContent = "";
    // 停止任何正在播放的音频
    window.speechSynthesis.cancel();
    wordAudio.pause();
    
    const lowerWord = word.toLowerCase();
    
    // 检查缓存中是否已有该单词的音频
    if (audioCache[lowerWord]) {
      // 播放缓存的音频
      audioCache[lowerWord].play().catch(error => {
        console.error('播放缓存音频失败:', error);
        fallbackToSpeechSynthesis(word);
      });
      return;
    }
    
    // 从dictionaryapi.dev获取单词发音
    fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${lowerWord}`)
      .then(res => {
        if (!res.ok) throw new Error('单词发音资源未找到');
        return res.json();
      })
      .then(data => {
        // 提取音频URL
        const phonetics = data[0]?.phonetics || [];
        const audioUrl = phonetics.find(p => p.audio)?.audio;
        
        if (audioUrl) {
          // 创建音频元素并缓存
          const audio = new Audio(audioUrl);
          audioCache[lowerWord] = audio;
          
          // 播放音频
          audio.play().catch(error => {
            console.error('播放音频失败:', error);
            fallbackToSpeechSynthesis(word);
          });
        } else {
          // 没有找到音频，使用语音合成
          fallbackToSpeechSynthesis(word);
        }
      })
      .catch(error => {
        console.error('获取单词发音失败:', error);
        audioErrorEl.textContent = "注意：使用备用发音";
        // 请求失败时使用语音合成
        fallbackToSpeechSynthesis(word);
      });
  }
  
  // 语音合成回退函数
  function fallbackToSpeechSynthesis(word) {
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.lang = "en-GB"; // 使用英式发音
    utterance.rate = 0.9; // 稍微放慢语速
    window.speechSynthesis.speak(utterance);
  }

  // 处理音频加载错误
  function handleAudioError() {
    audioErrorEl.textContent = "注意：使用备用发音";
  }

  function showPuzzle() {
    inPuzzle = true;
    letterBox.innerHTML = "";
    definitionEl.textContent = "";
    phoneticEl.textContent = "";
    resultEl.textContent = "";
    audioErrorEl.textContent = "";
    startReadingBtn.style.display = "none";
    // 重置语音识别状态
    isListening = false;
    startReadingBtn.textContent = "开始朗读";
    startReadingBtn.classList.remove("listening");
    
    // 确保跳过按钮显示并修改文本
    nextBtn.style.display = "inline-block";
    nextBtn.textContent = "进入下一关";
    prevBtn.style.display = "none";

    // 计算当前关卡星级
    const rate = levelCorrect / 8;
    let stars = 1;
    if (rate === 1) stars = 3;
    else if (rate >= 0.75) stars = 2;
    levelStars.push(stars);

    const unused = puzzleQuestions.filter(q => !q.used);
    if (unused.length === 0) {
      levelCorrect = 0;
      loadNext();
      return;
    }
    const puzzle = unused[Math.floor(Math.random() * unused.length)];
    puzzle.used = true;
    questionEl.textContent = `🎯 关卡挑战：${puzzle.question}`;
    definitionEl.innerHTML = `本关评分：${"⭐".repeat(stars)}`;

    puzzle.options.forEach(opt => {
      const btn = document.createElement("button");
      btn.textContent = opt;
      btn.className = "option-btn";
      btn.onclick = () => {
        if (opt === puzzle.answer) {
          resultEl.textContent = "🎉 答对了，进入下一关！";
          correctSound.play();
          level++;
          levelCorrect = 0;
          currentIndex = level * 8;
          saveProgress();
          setTimeout(() => {
            inPuzzle = false;
            prevBtn.style.display = "inline-block";
            loadNext();
          }, 1000);
        } else {
          resultEl.textContent = "😥 再试试！";
          wrongSound.play();
        }
      };
      optionsEl.appendChild(btn);
    });
  }

  function showMistakes() {
    if (wrongList.length === 0) {
      alert("目前没有错题！");
      return;
    }
    isReviewMode = true;
    currentReviewIndex = 0;
    loadNext();
  }

  function exitReview() {
    isReviewMode = false;
    prevBtn.style.display = "inline-block";
    loadNext();
  }

  // 重置进度
  function resetProgress() {
    if (confirm(`确定要重置"${wordFiles[currentFile].name}"的进度吗？`)) {
      currentIndex = 0;
      level = 0;
      correctCount = 0;
      wrongList = [];
      levelStars = [];
      puzzleQuestions.forEach(q => q.used = false);
      currentStreak = 0;
      levelCorrect = 0;
      // 重置语音识别状态
      isListening = false;
      startReadingBtn.textContent = "开始朗读";
      startReadingBtn.classList.remove("listening");
      saveProgress();
      loadNext();
    }
  }

  // 输入框事件监听
  function addInputListeners(input) {
    input.addEventListener('input', handleInput);
    input.addEventListener('keydown', handleKeyDown);
    input.addEventListener('compositionstart', () => isComposing = true);
    input.addEventListener('compositionend', (e) => {
      isComposing = false;
      handleInput(e);
    });
  }

  let isComposing = false;
  function handleInput(e) {
    if (isComposing) return;
    const input = e.target;
    input.value = input.value.slice(0, 1).toLowerCase();
    input.classList.add("correct");
    const next = input.nextElementSibling;
    if (next && next.tagName === 'INPUT') next.focus();
    
    autoCheckAnswer();
  }

  function handleKeyDown(e) {
    if (e.key === "Backspace") {
      const input = e.target;
      // 情况1：当前输入框有内容，删除后光标留在当前框
      if (input.value) {
        // 删除内容后移除"correct"样式
        input.value = "";
        input.classList.remove("correct");
        e.preventDefault();
      } 
      // 情况2：当前输入框为空，跳转到前一个输入框
      else {
        const prev = input.previousElementSibling;
        if (prev && prev.tagName === 'INPUT' && prev.classList.contains('letter-input')) {
          prev.focus();
          e.preventDefault();
        }
      }
    }
    // 支持左右方向键切换输入框
    else if (e.key === "ArrowLeft") {
      const input = e.target;
      const prev = input.previousElementSibling;
      if (prev && prev.tagName === 'INPUT' && prev.classList.contains('letter-input')) {
        prev.focus();
        e.preventDefault();
      }
    } else if (e.key === "ArrowRight") {
      const input = e.target;
      const next = input.nextElementSibling;
      if (next && next.tagName === 'INPUT' && next.classList.contains('letter-input')) {
        next.focus();
        e.preventDefault();
      }
    }
  }

  // 初始化游戏
  initFileSelector();
  loadFileProgress();
  initRecognition();
  loadNext();
</script>
</body>
</html>  
