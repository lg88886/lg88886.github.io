<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>单词拼写闯关游戏V4</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6', // 主色调：蓝色
            secondary: '#10B981', // 辅助色：绿色
            accent: '#F59E0B', // 强调色：橙色
            danger: '#EF4444', // 错误色：红色
            neutral: '#6B7280', // 中性色：灰色
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          animation: {
            'pop': 'pop 0.3s ease',
            'streak': 'streak 1s forwards',
            'fade-in': 'fadeIn 0.5s ease',
            'slide-up': 'slideUp 0.5s ease-out',
            'highlight': 'highlight 1s ease',
          },
          keyframes: {
            pop: {
              '0%, 100%': { transform: 'scale(1)' },
              '50%': { transform: 'scale(1.1)' },
            },
            streak: {
              '0%': { opacity: '0', transform: 'translate(-50%, -20px)' },
              '50%': { opacity: '1', transform: 'translate(-50%, 0)' },
              '100%': { opacity: '0', transform: 'translate(-50%, 20px)' },
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            highlight: {
              '0%, 100%': { background: '#EF4444' },
              '50%': { background: '#f87171' },
            }
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .word-input {
        @apply w-12 h-12 sm:w-10 sm:h-10 rounded-md border-2 border-gray-300 text-center text-xl font-medium transition-all duration-300;
        text-transform: lowercase; /* 强制显示小写 */
      }
      .word-input::placeholder {
        text-transform: none; /* 确保占位符不受影响 */
      }
      .word-input:focus {
        @apply border-primary ring-2 ring-primary/30;
      }
      .word-input.correct {
        @apply border-secondary bg-green-50 animate-pop;
      }
      .word-input.wrong {
        @apply border-danger bg-red-50;
      }
      .fixed-letter {
        @apply w-12 h-12 sm:w-10 sm:h-10 rounded-md border-2 border-gray-300 bg-gray-100 text-gray-600 text-center text-xl font-medium flex items-center justify-center cursor-not-allowed;
      }
      .game-btn {
        @apply px-4 py-3 sm:px-5 sm:py-2.5 rounded-lg font-medium transition-all duration-300 hover:translate-y-[-2px] hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2;
      }
      .streak-effect {
        @apply fixed top-1/4 left-1/2 transform -translate-x-1/2 text-4xl font-bold text-accent opacity-0 pointer-events-none animate-streak;
      }
      .progress-bar {
        @apply h-2 rounded-full overflow-hidden bg-gray-200;
      }
      .progress-fill {
        @apply h-full transition-all duration-500 ease-out;
      }
      .level-badge {
        @apply inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800;
      }
      .reward-card {
        @apply bg-gradient-to-br from-yellow-100 to-orange-100 rounded-xl p-4 border border-yellow-200 shadow-lg transition-all duration-500 animate-fade-in;
      }
      .listening {
        background-color: #ef4444 !important;
      }
      #similarityMeter {
        transition: all 0.3s ease;
      }
      .word-input.highlight {
        animation: highlight 1s ease;
      }
      /* 移动端按钮布局优化 */
      .btn-group {
        @apply grid grid-cols-2 gap-2 sm:flex sm:gap-2;
      }
      .btn-group .game-btn {
        @apply flex-1 justify-center;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen font-sans">
  <div class="max-w-3xl mx-auto px-4 py-6 sm:py-8">
    <!-- 游戏标题 -->
    <div class="text-center mb-6 sm:mb-8 animate-fade-in">
      <h1 class="text-[clamp(1.8rem,5vw,3rem)] font-bold text-gray-800 mb-2">
        <i class="fa fa-book text-primary mr-2"></i>单词拼写闯关游戏
      </h1>
      <p class="text-gray-600 text-base sm:text-lg">提升你的英语词汇量，挑战自我！</p>
    </div>

    <!-- 游戏主容器 -->
    <div class="bg-white rounded-xl p-5 sm:p-6 shadow-lg mb-6 animate-fade-in">
      <!-- 文件选择区域 -->
      <div class="mb-5 pb-4 border-b border-gray-100">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
          <div class="w-full sm:w-auto">
            <label class="block text-sm font-medium text-gray-700 mb-1">选择单词文件：</label>
            <select id="wordFileSelect" class="w-full sm:w-auto px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
              <option value="default">默认单词库</option>
              <option value="two">二年级单词</option>
              <option value="basic">新概念1词库</option>
            </select>
          </div>
          <div class="flex gap-2 w-full sm:w-auto">
            <button onclick="deleteCurrentFile()" id="deleteFileBtn" class="game-btn bg-red-500 text-white focus:ring-red-500 flex-1 sm:flex-none">
              <i class="fa fa-trash-o mr-1"></i> 删除进度
            </button>
            <button onclick="resetProgress()" class="game-btn bg-gray-200 text-gray-700 focus:ring-gray-400 flex-1 sm:flex-none">
              <i class="fa fa-refresh mr-1"></i> 重置进度
            </button>
          </div>
        </div>
        <div id="fileNotification" class="mt-2 text-sm text-gray-600"></div>
      </div>

      <!-- 游戏内容区域 -->
      <div id="content" class="space-y-5">
        <!-- 关卡和题目信息 -->
        <div class="animate-slide-up">
          <div id="instruction" class="text-lg font-semibold text-gray-800 mb-1"></div>
          <div id="stats" class="flex flex-wrap gap-2 text-sm text-gray-600"></div>
        </div>

        <!-- 单词信息 -->
        <div class="bg-blue-50 rounded-lg p-4 mb-5 animate-slide-up" style="animation-delay: 0.1s">
          <div id="question" class="text-base font-medium text-gray-800 mb-2"></div>
          <div id="definition" class="text-lg text-primary font-medium mb-1"></div>
          <div id="phonetic" class="text-base text-indigo-500 italic"></div>
        </div>

        <!-- 单词输入区域 -->
        <div class="flex justify-center mb-5 animate-slide-up" style="animation-delay: 0.2s">
          <div id="letterBox" class="flex gap-2 flex-wrap justify-center"></div>
        </div>

        <!-- 操作按钮 - 移动端优化布局 -->
        <div class="mb-5 animate-slide-up" style="animation-delay: 0.3s">
          <div class="btn-group mb-2">
            <button onclick="prevQuestion()" id="prevBtn" class="game-btn bg-gray-200 text-gray-700 focus:ring-gray-400">
              <i class="fa fa-arrow-left mr-1"></i> 上一题
            </button>
            <button onclick="toggleListening()" id="startReadingBtn" class="game-btn bg-orange-500 text-white focus:ring-orange-500">
              <i class="fa fa-microphone mr-1"></i> 开始朗读
            </button>
          </div>
          <div class="btn-group">
            <button onclick="readWord()" class="game-btn bg-primary text-white focus:ring-primary">
              <i class="fa fa-volume-up mr-1"></i> 听单词
            </button>
            <button onclick="showMistakes()" class="game-btn bg-green-500 text-white focus:ring-green-500">
              <i class="fa fa-book mr-1"></i> 查看错题本
            </button>
          </div>
          <div class="btn-group mt-2">
            <button onclick="submitAnswer()" id="nextBtn" class="game-btn bg-gray-200 text-gray-700 focus:ring-gray-400">
              跳过此题 <i class="fa fa-arrow-right ml-1"></i>
            </button>
            <button onclick="exitReview()" class="game-btn bg-green-500 text-white focus:ring-green-500" style="display:none">
              <i class="fa fa-arrow-left mr-1"></i> 返回闯关
            </button>
            <button onclick="nextQuestion()" id="continueBtn" class="game-btn bg-secondary text-white focus:ring-secondary" style="display:none">
              <i class="fa fa-arrow-right mr-1"></i> 继续下一题
            </button>
          </div>
        </div>

        <!-- 相似度指示器 -->
        <div id="similarityMeter" class="progress-bar mb-5 animate-slide-up" style="animation-delay: 0.4s; display: none">
          <div class="progress-fill bg-primary" id="similarityFill"></div>
        </div>

        <!-- 选项区域 -->
        <div id="options" class="space-y-2 animate-slide-up" style="animation-delay: 0.5s"></div>

        <!-- 结果区域 -->
        <div id="result" class="mt-4 p-4 rounded-lg text-center font-medium animate-slide-up" style="animation-delay: 0.6s"></div>

        <!-- 连续正确奖励区域 -->
        <div id="streakReward" class="hidden reward-card mt-5">
          <h3 class="font-bold text-lg text-orange-600 mb-2">连续正确奖励!</h3>
          <p id="rewardMessage" class="text-gray-700 mb-3"></p>
          <div class="flex justify-center">
            <button onclick="claimReward()" class="game-btn bg-orange-500 text-white focus:ring-orange-500">
              <i class="fa fa-gift mr-1"></i> 领取奖励
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 底部信息 -->
    <div class="text-center text-gray-500 text-sm mt-6 animate-fade-in">
      <p>单词拼写闯关游戏 V4 © 2025 | 提升你的英语词汇量</p>
    </div>
  </div>

  <!-- 音频元素 -->
  <audio id="bgm" autoplay loop>
    <source src="https://cdn.pixabay.com/audio/2022/10/30/audio_46fdd201cc.mp3" type="audio/mpeg">
  </audio>
  <audio id="correct-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_e0b6f67a53.mp3"></audio>
  <audio id="wrong-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_2307f9b816.mp3"></audio>
  <audio id="reward-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_139c839a53.mp3"></audio>

  <!-- 连续正确提示 -->
  <div id="streakEffect" class="streak-effect"></div>

  <script>
    // 核心单词库
    const defaultWordList = [
      {word:"morning", definition:"早晨；上午", phonetic:"/ˈmɔːnɪŋ/"},
      {word:"afternoon", definition:"午后；下午", phonetic:"/ˌɑːftəˈnuːn/"},
      {word:"evening", definition:"晚上；傍晚", phonetic:"/ˈiːvnɪŋ/"},
      {word:"night", definition:"夜间；夜晚", phonetic:"/naɪt/"},
      {word:"fine", definition:"好的", phonetic:"/faɪn/"},
      {word:"thank", definition:"感谢", phonetic:"/θæŋk/"},
      {word:"goodbye", definition:"再见", phonetic:"/ˌɡʊdˈbaɪ/"},
      {word:"woof", definition:"狗叫声", phonetic:"/wʊf/"},
      {word:"Mrs", definition:"夫人；太太", phonetic:"/ˈmɪsɪz/"},
      {word:"day", definition:"一天", phonetic:"/deɪ/"},
      {word:"today", definition:"今天", phonetic:"/təˈdeɪ/"},
    ];

    // 关卡谜题
    const puzzleQuestions = [
      { question: "“日出大米”猜一个字？", options: ["明", "昌", "早", "亮"], answer: "昌" },
      { question: "什么东西越洗越脏？", options: ["衣服", "手", "水", "地板"], answer: "水" },
      { question: "哪种狗不会叫？", options: ["热狗", "藏獒", "哈士奇", "牧羊犬"], answer: "热狗" },
    ];

    // 发音变体（用于容错）
    const pronunciationVariants = {
      "morning": ["mornin", "mornning"],
      "afternoon": ["afternun", "afternooon"],
      "evening": ["evenin", "evenning"],
    };

    // 连续正确奖励配置
    const streakRewards = {
      3: {
        description: "获得额外星星！",
        action: () => {
          levelStars[level] = Math.min((levelStars[level] || 0) + 1, 3);
          return `当前关卡星星：${levelStars[level]}/3 ⭐`;
        }
      },
      5: {
        description: "跳过一个单词",
        action: () => {
          currentIndex++;
          return "已自动跳过下一个单词！";
        }
      }
    };

    // 游戏核心变量
    let wordFiles = { 
      "default": { name: "默认单词库", words: defaultWordList, isCustom: false, loaded: true },
      "two": { name: "二年级单词", words: [], isCustom: true, loaded: false },
      "basic": { name: "新概念1词库", words: [], isCustom: true, loaded: false }
    };
    let currentFile = "default";
    let gameData = JSON.parse(localStorage.getItem('wordGameData')) || {
      currentIndex: 0, level: 0, correctCount: 0, wrongList: [], levelStars: [], puzzleQuestionsUsed: []
    };

    // 内存变量
    let { currentIndex, level, correctCount, wrongList, levelStars } = gameData;
    let inPuzzle = false;
    let isReviewMode = false;
    let currentStreak = 0;
    let currentReviewIndex = 0;
    let levelCorrect = 0;
    let recognition;
    let isListening = false;
    let showFullFirstLetter = false;
    let answerCorrect = false; // 标记答案是否正确
    let speechSynthAvailable = false; // 语音合成可用状态

    // DOM元素
    const [instructionEl, questionEl, resultEl, optionsEl, definitionEl, phoneticEl, letterBox, statsEl] = 
      ["instruction", "question", "result", "options", "definition", "phonetic", "letterBox", "stats"].map(id => document.getElementById(id));
    const [nextBtn, prevBtn, startReadingBtn, deleteFileBtn, fileNotification, similarityMeter, similarityFill, streakReward, rewardMessage] =
      ["nextBtn", "prevBtn", "startReadingBtn", "deleteFileBtn", "fileNotification", "similarityMeter", "similarityFill", "streakReward", "rewardMessage"].map(id => document.getElementById(id));
    const [correctSound, wrongSound, rewardSound] = 
      ["correct-sound", "wrong-sound", "reward-sound"].map(id => document.getElementById(id));
    const readWordBtn = document.querySelector('button[onclick="readWord()"]');

    // 初始化
    function init() {
      document.getElementById("wordFileSelect").addEventListener('change', loadSelectedWordFile);
      loadFileProgress();
      updateDeleteButton();
      loadNext();
      initSpeechRecognition();
      checkSpeechSynthesis();
    }

    // 检查语音合成支持
    function checkSpeechSynthesis() {
      if ('speechSynthesis' in window) {
        speechSynthAvailable = true;
        readWordBtn.disabled = false;
        readWordBtn.title = "";
      } else {
        speechSynthAvailable = false;
        readWordBtn.disabled = true;
        readWordBtn.title = "您的浏览器不支持语音合成";
      }
    }

    // 更新删除按钮状态
    function updateDeleteButton() {
      const isCustom = wordFiles[currentFile]?.isCustom;
      deleteFileBtn.disabled = !isCustom;
      deleteFileBtn.title = isCustom ? "" : "默认单词库不能删除";
    }

    // 加载单词文件
    function loadSelectedWordFile() {
      const selectedFile = document.getElementById("wordFileSelect").value;
      if (selectedFile === currentFile) return;
      
      saveCurrentFileProgress();
      currentFile = selectedFile;
      fileNotification.textContent = "";
      updateDeleteButton();
      
      const file = wordFiles[currentFile];
      if (!file.loaded) {
        fileNotification.textContent = `正在加载 ${file.name}...`;
        
        // 词库文件路径
        const fileName = {
          "two": "two_words.txt",
          "basic": "basic_words.txt"
        }[currentFile];

        // 读取并解析逗号分隔的TXT文件
        fetch(fileName)
          .then(response => {
            if (!response.ok) throw new Error("文件不存在或加载失败");
            return response.text();
          })
          .then(text => {
            const words = [];
            // 按行分割，过滤空行和无效行
            const lines = text.split('\n')
              .map(line => line.trim())
              .filter(line => line);

            lines.forEach((line, index) => {
              // 按英文逗号分割
              const parts = line.split(',');
              
              // 校验格式（至少包含单词和释义）
              if (parts.length < 2) {
                console.warn(`第${index+1}行格式错误（需逗号分隔），跳过：${line}`);
                return;
              }
              
              // 提取字段
              words.push({
                word: parts[0].trim(),
                definition: parts[1].trim(),
                phonetic: parts[2]?.trim() || '无'
              });
            });

            if (words.length === 0) {
              throw new Error("未解析到有效单词，请检查文件格式");
            }

            // 加载成功，更新游戏数据
            file.words = words;
            file.loaded = true;
            fileNotification.textContent = `加载成功！共 ${words.length} 个单词`;
            loadFileProgress();
            loadNext();
          })
          .catch(error => {
            fileNotification.textContent = `加载失败：${error.message}`;
            console.error("词库加载错误：", error);
          });
        return;
      }
      
      loadFileProgress();
      loadNext();
    }

    // 进度存储与加载
    function saveCurrentFileProgress() {
      const progressData = JSON.parse(localStorage.getItem('wordFileProgress') || '{}');
      progressData[currentFile] = {
        currentIndex, level, correctCount, wrongList, levelStars
      };
      localStorage.setItem('wordFileProgress', JSON.stringify(progressData));
    }

    function loadFileProgress() {
      const progressData = JSON.parse(localStorage.getItem('wordFileProgress') || '{}');
      const fileProgress = progressData[currentFile] || {};
      currentIndex = fileProgress.currentIndex || 0;
      level = fileProgress.level || 0;
      correctCount = fileProgress.correctCount || 0;
      wrongList = fileProgress.wrongList || [];
      levelStars = fileProgress.levelStars || [];
    }

    // 更新统计信息
    function updateStats() {
      const currentWords = wordFiles[currentFile].words;
      statsEl.innerHTML = `
        <div><i class="fa fa-check-circle text-green-500 mr-1"></i> 正确：<b>${correctCount}</b></div>
        <div><i class="fa fa-times-circle text-red-500 mr-1"></i> 错误：<b>${wrongList.length}</b></div>
        <div><i class="fa fa-book text-primary mr-1"></i> 进度：<b>${currentIndex + 1}/${currentWords.length}</b></div>
      `;
    }

    // 加载下一题
    function loadNext() {
      // 新增：清除谜题问题
      questionEl.textContent = "";
      // 重置UI状态
      resultEl.textContent = "";
      optionsEl.innerHTML = "";
      letterBox.innerHTML = "";
      similarityMeter.style.display = "none";
      streakReward.classList.add("hidden");
      nextBtn.style.display = "inline-block";
      continueBtn.style.display = "none";
      answerCorrect = false;
      updateStats();

      // 按钮状态更新
      nextBtn.textContent = isReviewMode ? "下一个错题" : "跳过此题";
      prevBtn.disabled = isReviewMode ? currentReviewIndex <= 0 : currentIndex <= 0;

      // 错题回顾模式
      if (isReviewMode) {
        document.querySelector('button[onclick="exitReview()"]').style.display = "inline-block";
        if (wrongList.length === 0) {
          instructionEl.textContent = "🎉 恭喜你攻克了所有错题！";
          definitionEl.textContent = "继续加油哦！";
          phoneticEl.textContent = "";
          nextBtn.style.display = "none";
          prevBtn.style.display = "none";
          return;
        }
        currentReviewIndex = Math.min(currentReviewIndex, wrongList.length - 1);
        const wordObj = wrongList[currentReviewIndex];
        instructionEl.innerHTML = `<span class="level-badge">错题回顾</span> 第 ${currentReviewIndex + 1}/${wrongList.length} 题`;
        definitionEl.textContent = `中文提示：${wordObj.definition}`;
        phoneticEl.textContent = `音标：${wordObj.phonetic || '无'}`;
        generateInputBoxes(wordObj);
        return;
      }

      // 正常闯关模式
      document.querySelector('button[onclick="exitReview()"]').style.display = "none";
      const start = level * 5;
      const currentWords = wordFiles[currentFile].words;
      
      // 关卡完成，显示谜题
      if (currentIndex - start >= 5 && !inPuzzle) {
        showPuzzle();
        return;
      }
      
      // 全部完成
      if (currentIndex >= currentWords.length) {
        instructionEl.textContent = "🎉 恭喜你完成所有单词！";
        definitionEl.innerHTML = `总星级：${levelStars.reduce((a, b) => a + b, 0)}/${levelStars.length * 3} ⭐`;
        phoneticEl.textContent = "";
        nextBtn.style.display = "none";
        prevBtn.style.display = "none";
        return;
      }

      // 显示当前单词
      const wordObj = currentWords[currentIndex];
      instructionEl.innerHTML = `<span class="level-badge">第 ${level + 1} 关</span> 第 ${currentIndex - start + 1}/5 题`;
      definitionEl.textContent = `中文提示：${wordObj.definition}`;
      phoneticEl.textContent = `音标：${wordObj.phonetic || '无'}`;
      generateInputBoxes(wordObj);
	  
	  // 新增：自动朗读单词
	  if (speechSynthAvailable) {
		readWord();
	  }
    }

    // 生成输入框 - 已修改：去除首字母固定显示
    function generateInputBoxes(wordObj) {
      // 生成所有字母的输入框（包括首字母）
      for (let i = 0; i < wordObj.word.length; i++) {
        const input = document.createElement("input");
        input.type = "text";
        input.maxLength = 1;
        input.className = "word-input";
        input.dataset.index = i;
        // 确保输入转换为小写
        input.addEventListener('input', function() {
          if (this.value) {
            this.value = this.value.toLowerCase();
          }
        });
        addInputListeners(input);
        letterBox.appendChild(input);
      }
      letterBox.querySelector("input")?.focus();
    }

    // 输入框事件监听
    function addInputListeners(input) {
      // 输入后自动跳到下一个
      input.addEventListener('input', function() {
        if (this.value) {
          const next = this.nextElementSibling;
          if (next?.tagName === "INPUT") {
            next.focus();
          } else {
            checkAnswer(); // 最后一个输入框填满后自动检查
          }
        }
      });

      // 退格键处理
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && !this.value) {
          const prev = this.previousElementSibling;
          if (prev?.tagName === "INPUT") {
            prev.focus();
          }
        }
      });
    }

    // 检查答案
    function checkAnswer() {
      const currentWords = wordFiles[currentFile].words;
      const currentWord = isReviewMode 
        ? wrongList[currentReviewIndex] 
        : currentWords[currentIndex];
      
      // 获取用户输入（确保全部转为小写）
      const inputs = letterBox.querySelectorAll("input");
      let userAnswer = "";
      inputs.forEach(input => userAnswer += (input.value || '').toLowerCase());

      // 检查是否填满
      if (userAnswer.length !== currentWord.word.length) return;

      // 相似度计算
      similarityMeter.style.display = "block";
      const similarity = calculateSimilarity(userAnswer, currentWord.word.toLowerCase());
      similarityFill.style.width = `${similarity * 100}%`;

      // 判断对错
      const isCorrect = userAnswer === currentWord.word.toLowerCase() || 
        (pronunciationVariants[currentWord.word]?.includes(userAnswer) ?? false);

      // 标记输入框状态
      inputs.forEach((input, i) => {
        const correctChar = currentWord.word[i].toLowerCase();
        input.className = `word-input ${input.value.toLowerCase() === correctChar ? 'correct' : 'wrong'}`;
      });

      // 处理结果
      if (isCorrect) {
        resultEl.className = "mt-4 p-4 rounded-lg bg-green-100 text-green-800";
        resultEl.textContent = `🎉 正确！单词：${currentWord.word}`;
        correctSound.play();
        answerCorrect = true;
        continueBtn.style.display = "inline-block";
        nextBtn.style.display = "none";
        
        // 提示用户朗读单词
        setTimeout(() => {
          resultEl.textContent += " 请朗读单词以继续下一题";
          startReadingBtn.focus();
        }, 500);
      } else {
        resultEl.className = "mt-4 p-4 rounded-lg bg-red-100 text-red-800";
        resultEl.textContent = `❌ 错误！正确单词：${currentWord.word}`;
        wrongSound.play();
        currentStreak = 0;
        
        // 添加到错题本
        if (!wrongList.some(w => w.word === currentWord.word)) {
          wrongList.push(currentWord);
        }

        // 高亮错误字母1秒后清空
        setTimeout(() => {
          const inputs = letterBox.querySelectorAll("input");
          inputs.forEach((input, i) => {
            const correctChar = currentWord.word[i].toLowerCase();
            if (input.value.toLowerCase() !== correctChar) {
              input.classList.add('highlight');
            }
          });
          
          // 1秒后清空输入框
          setTimeout(() => {
            inputs.forEach(input => {
              input.value = '';
              input.className = 'word-input';
              input.classList.remove('highlight');
            });
            letterBox.querySelector("input")?.focus();
          }, 1000);
        }, 500);
      }

      saveProgress();
    }

    // 显示连续正确效果
    function showStreakEffect() {
      const streakEl = document.getElementById("streakEffect");
      streakEl.textContent = `+${currentStreak} 连击！`;
      streakEl.style.display = "block";
      setTimeout(() => {
        streakEl.style.display = "none";
      }, 1000);
    }

    // 下一题处理
    function nextQuestion() {
      if (isReviewMode) {
        currentReviewIndex++;
      } else {
        // 只有答案正确且已朗读才能继续
        if (!answerCorrect) return;
        
        correctCount++;
        currentStreak++;
        levelCorrect++;
        
        // 检查连续正确奖励
        if (streakRewards[currentStreak]) {
          showReward(currentStreak);
          return;
        }
        
        currentIndex++;
      }
      loadNext();
    }

    // 上一题
    function prevQuestion() {
      if (isReviewMode) {
        if (currentReviewIndex > 0) currentReviewIndex--;
      } else if (currentIndex > 0) {
        currentIndex--;
        // 调整计数
        const currentWord = wordFiles[currentFile].words[currentIndex];
        if (!wrongList.some(w => w.word === currentWord.word)) {
          correctCount--;
          if (currentStreak > 0) currentStreak--;
        }
      }
      loadNext();
    }

    // 跳过当前题
    function submitAnswer() {
      if (isReviewMode) {
        currentReviewIndex++;
        loadNext();
        return;
      }

      if (inPuzzle) {
        // 谜题跳过，进入下一关
        level++;
        levelCorrect = 0;
        currentIndex = level * 5;
        inPuzzle = false;
        loadNext();
        return;
      }

      // 正常题跳过（加入错题）
      const currentWord = wordFiles[currentFile].words[currentIndex];
      if (!wrongList.some(w => w.word === currentWord.word)) {
        wrongList.push(currentWord);
      }
      currentStreak = 0;
      currentIndex++;
      saveProgress();
      loadNext();
    }

    // 显示谜题
    function showPuzzle() {
      inPuzzle = true;
      // 选择未使用的谜题
      let availablePuzzles = puzzleQuestions.filter(q => !gameData.puzzleQuestionsUsed.includes(puzzleQuestions.indexOf(q)));
      if (availablePuzzles.length === 0) {
        availablePuzzles = puzzleQuestions;
        gameData.puzzleQuestionsUsed = [];
      }
      const puzzle = availablePuzzles[Math.floor(Math.random() * availablePuzzles.length)];
      gameData.puzzleQuestionsUsed.push(puzzleQuestions.indexOf(puzzle));

      // 显示谜题
      instructionEl.innerHTML = `<span class="level-badge">第 ${level + 1} 关奖励</span> 完成关卡，挑战谜题！`;
      questionEl.textContent = puzzle.question;
      definitionEl.textContent = "请选择正确答案：";
      phoneticEl.textContent = "";
      letterBox.innerHTML = "";

      // 生成选项
      puzzle.options.forEach(option => {
        const btn = document.createElement("button");
        btn.className = "game-btn bg-gray-200 text-gray-700 w-full text-left mb-2";
        btn.textContent = option;
        btn.onclick = () => checkPuzzleAnswer(puzzle, option);
        optionsEl.appendChild(btn);
      });
    }

    // 检查谜题答案
    function checkPuzzleAnswer(puzzle, selected) {
      const buttons = optionsEl.querySelectorAll("button");
      buttons.forEach(btn => {
        btn.disabled = true;
        if (btn.textContent === puzzle.answer) {
          btn.className = "game-btn bg-green-500 text-white w-full text-left mb-2";
        } else if (btn.textContent === selected) {
          btn.className = "game-btn bg-red-500 text-white w-full text-left mb-2";
        }
      });

      // 处理结果
      if (selected === puzzle.answer) {
        resultEl.className = "mt-4 p-4 rounded-lg bg-green-100 text-green-800";
        resultEl.textContent = "🎉 恭喜你答对了！获得额外星星！";
        correctSound.play();
        // 奖励星星
        levelStars[level] = Math.min((levelStars[level] || 0) + 1, 3);
      } else {
        resultEl.className = "mt-4 p-4 rounded-lg bg-red-100 text-red-800";
        resultEl.textContent = `❌ 正确答案是：${puzzle.answer}`;
        wrongSound.play();
      }

      // 进入下一关
      setTimeout(() => {
        level++;
        levelCorrect = 0;
        currentIndex = level * 5;
        inPuzzle = false;
        saveProgress();
        loadNext();
      }, 1500);
    }

    // 语音识别初始化
    function initSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        startReadingBtn.disabled = true;
        startReadingBtn.title = "你的浏览器不支持语音识别";
        return;
      }

      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.toLowerCase();
        
        // 获取当前单词（转为小写）
        const currentWord = isReviewMode 
          ? wrongList[currentReviewIndex].word.toLowerCase()
          : wordFiles[currentFile].words[currentIndex].word.toLowerCase();
        
        // 检查语音是否匹配单词（包括变体）
        const variants = [currentWord, ...(pronunciationVariants[currentWord] || [])];
        const isMatch = variants.some(variant => 
          transcript.includes(variant) || variant.includes(transcript)
        );

        // 处理识别结果
        if (isMatch) {
          if (answerCorrect) {
            resultEl.textContent = `🎉 语音识别成功！单词：${currentWord}`;
            setTimeout(() => {
              correctCount++;
              currentStreak++;
              levelCorrect++;
              
              // 移除错题（如果在复习模式）
              if (isReviewMode) {
                wrongList = wrongList.filter(w => w.word.toLowerCase() !== currentWord);
              }
              
              saveProgress();
              nextQuestion();
            }, 1000);
          } else {
            resultEl.textContent = `语音识别：${transcript}，请先正确拼写单词`;
          }
        } else {
          resultEl.textContent = `未能识别："${transcript}"，请尝试再次朗读 "${currentWord}"`;
        }
      };

      recognition.onend = () => {
        isListening = false;
        startReadingBtn.textContent = "开始朗读";
        startReadingBtn.classList.remove("listening");
      };
    }

    // 切换语音识别状态
    function toggleListening() {
      if (!recognition) return;
      
      if (isListening) {
        recognition.stop();
        isListening = false;
        startReadingBtn.textContent = "开始朗读";
        startReadingBtn.classList.remove("listening");
      } else {
        recognition.start();
        isListening = true;
        startReadingBtn.textContent = "正在聆听...";
        startReadingBtn.classList.add("listening");
        resultEl.textContent = "请朗读单词...";
      }
    }

    // 保存进度
    function saveProgress() {
      gameData = { ...gameData, currentIndex, level, correctCount, wrongList, levelStars };
      localStorage.setItem('wordGameData', JSON.stringify(gameData));
      saveCurrentFileProgress();
    }

    // 显示奖励
    function showReward(streak) {
      const reward = streakRewards[streak];
      rewardMessage.innerHTML = `${reward.description}<br>${reward.action()}`;
      streakReward.classList.remove("hidden");
      rewardSound.play();
    }

    // 领取奖励
    function claimReward() {
      streakReward.classList.add("hidden");
      nextQuestion();
    }

    // 显示错题
    function showMistakes() {
      isReviewMode = true;
      currentReviewIndex = 0;
      loadNext();
    }

    // 退出复习模式
    function exitReview() {
      isReviewMode = false;
      loadNext();
    }

    // 重置进度
    function resetProgress() {
      if (confirm("确定要重置当前单词库的进度吗？")) {
        const progressData = JSON.parse(localStorage.getItem('wordFileProgress') || '{}');
        delete progressData[currentFile];
        localStorage.setItem('wordFileProgress', JSON.stringify(progressData));
        loadFileProgress();
        loadNext();
      }
    }

    // 删除当前文件
    function deleteCurrentFile() {
      if (currentFile === "default") {
        alert("默认单词库不能删除");
        return;
      }
      if (confirm(`确定要删除"${wordFiles[currentFile].name}"的所有数据吗？`)) {
        const progressData = JSON.parse(localStorage.getItem('wordFileProgress') || '{}');
        delete progressData[currentFile];
        localStorage.setItem('wordFileProgress', JSON.stringify(progressData));
        wordFiles[currentFile].loaded = false;
        wordFiles[currentFile].words = [];
        currentFile = "default";
        document.getElementById("wordFileSelect").value = "default";
        updateDeleteButton();
        loadFileProgress();
        loadNext();
      }
    }

    // 语音朗读功能
    function readWord() {
      if (!speechSynthAvailable) return;
      
      // 停止任何正在进行的语音合成
      window.speechSynthesis.cancel();
      
      // 获取当前单词
      const currentWord = isReviewMode 
        ? wrongList[currentReviewIndex].word
        : wordFiles[currentFile].words[currentIndex].word;
      
      // 创建语音合成实例
      const utterance = new SpeechSynthesisUtterance(currentWord);
      utterance.lang = 'en-US';
      utterance.rate = 0.9; // 稍微降低语速，便于学习
      
      // 设置朗读完成后的回调
      utterance.onend = () => {
        console.log(`朗读完成: ${currentWord}`);
      };
      
      utterance.onerror = (event) => {
        console.error(`语音合成错误: ${event.error}`);
        resultEl.textContent = "语音合成出错，请稍后再试";
      };
      
      // 开始朗读
      window.speechSynthesis.speak(utterance);
    }

    // 计算字符串相似度
    function calculateSimilarity(s1, s2) {
      if (s1 === s2) return 1;
      const longer = s1.length > s2.length ? s1 : s2;
      const shorter = s1.length > s2.length ? s2 : s1;
      const longerLen = longer.length;
      if (longerLen === 0) return 1.0;
      
      return (longerLen - editDistance(longer, shorter)) / parseFloat(longerLen);
    }

    // 编辑距离算法
    function editDistance(s1, s2) {
      s1 = s1.toLowerCase();
      s2 = s2.toLowerCase();
      
      const costs = [];
      for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
          if (i === 0) costs[j] = j;
          else {
            if (j > 0) {
              let newValue = costs[j - 1];
              if (s1.charAt(i - 1) !== s2.charAt(j - 1))
                newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
              costs[j - 1] = lastValue;
              lastValue = newValue;
            }
          }
        }
        if (i > 0) costs[s2.length] = lastValue;
      }
      return costs[s2.length];
    }

    // 页面加载完成后初始化游戏
    window.onload = init;
  </script>
</body>
</html>
