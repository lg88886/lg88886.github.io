<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>单词拼写游戏V3.4 - 按课时学习</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6', // 主色调：蓝色
            secondary: '#10B981', // 辅助色：绿色
            accent: '#F59E0B', // 强调色：橙色
            danger: '#EF4444', // 错误色：红色
            neutral: '#6B7280', // 中性色：灰色
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          animation: {
            'pop': 'pop 0.3s ease',
            'streak': 'streak 1s forwards',
            'fade-in': 'fadeIn 0.5s ease',
            'slide-up': 'slideUp 0.5s ease-out',
            'highlight': 'highlight 1s ease',
          },
          keyframes: {
            pop: {
              '0%, 100%': { transform: 'scale(1)' },
              '50%': { transform: 'scale(1.1)' },
            },
            streak: {
              '0%': { opacity: '0', transform: 'translate(-50%, -20px)' },
              '50%': { opacity: '1', transform: 'translate(-50%, 0)' },
              '100%': { opacity: '0', transform: 'translate(-50%, 20px)' },
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            highlight: {
              '0%, 100%': { background: '#EF4444' },
              '50%': { background: '#f87171' },
            }
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .word-input {
        @apply w-12 h-12 sm:w-10 sm:h-10 rounded-md border-2 border-gray-300 text-center text-xl font-medium transition-all duration-300;
        text-transform: lowercase; /* 强制显示小写 */
      }
      .word-input::placeholder {
        text-transform: none; /* 确保占位符不受影响 */
      }
      .word-input:focus {
        @apply border-primary ring-2 ring-primary/30;
      }
      .word-input.correct {
        @apply border-secondary bg-green-50 animate-pop;
      }
      .word-input.wrong {
        @apply border-danger bg-red-50;
      }
      .fixed-letter {
        @apply w-12 h-12 sm:w-10 sm:h-10 rounded-md border-2 border-gray-300 bg-gray-100 text-gray-600 text-center text-xl font-medium flex items-center justify-center cursor-not-allowed;
      }
      .game-btn {
        @apply px-4 py-3 sm:px-5 sm:py-2.5 rounded-lg font-medium transition-all duration-300 hover:translate-y-[-2px] hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2;
      }
      .streak-effect {
        @apply fixed top-1/4 left-1/2 transform -translate-x-1/2 text-4xl font-bold text-accent opacity-0 pointer-events-none animate-streak;
      }
      .progress-bar {
        @apply h-2 rounded-full overflow-hidden bg-gray-200;
      }
      .progress-fill {
        @apply h-full transition-all duration-500 ease-out;
      }
      .level-badge {
        @apply inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800;
      }
      .reward-card {
        @apply bg-gradient-to-br from-yellow-100 to-orange-100 rounded-xl p-4 border border-yellow-200 shadow-lg transition-all duration-500 animate-fade-in;
      }
      .listening {
        background-color: #ef4444 !important;
      }
      #similarityMeter {
        transition: all 0.3s ease;
      }
      .word-input.highlight {
        animation: highlight 1s ease;
      }
      /* 移动端按钮布局优化 */
      .btn-group {
        @apply grid grid-cols-2 gap-2 sm:flex sm:gap-2;
      }
      .btn-group .game-btn {
        @apply flex-1 justify-center;
      }
      /* 选择器容器样式 */
      .selector-container {
        @apply grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4;
      }
      .form-selector {
        @apply flex flex-col space-y-1;
      }
      .select-wrapper {
        @apply relative;
      }
      .select-wrapper::after {
        content: "▼";
        @apply absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none;
      }
      .custom-select {
        @apply w-full px-4 py-2.5 rounded-lg border border-gray-300 bg-white appearance-none focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all;
      }
      .stats-badge {
        @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800;
      }
      .reward-card {
        @apply bg-gradient-to-br from-yellow-100 to-orange-100 rounded-xl p-4 border border-yellow-200 shadow-lg transition-all duration-500 animate-fade-in;
      }
      .listening {
        background-color: #ef4444 !important;
      }
      #similarityMeter {
        transition: all 0.3s ease;
      }
      .word-input.highlight {
        animation: highlight 1s ease;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen font-sans">
  <div class="max-w-3xl mx-auto px-4 py-6 sm:py-8">
    <!-- 游戏标题 -->
    <div class="text-center mb-6 sm:mb-8 animate-fade-in">
      <h1 class="text-[clamp(1.8rem,5vw,3rem)] font-bold text-gray-800 mb-2">
        <i class="fa fa-book text-primary mr-2"></i>单词拼写游戏
      </h1>
      <p class="text-gray-600 text-base sm:text-lg">提升你的英语词汇量！</p>
    </div>


    <!-- 游戏主容器 -->
    <div class="bg-white rounded-xl p-5 sm:p-6 shadow-lg mb-6 animate-fade-in">
      <!-- 文件和课时选择区域 -->
      <div class="mb-5 pb-4 border-b border-gray-100">
        <!-- 选择器容器 - 移动端垂直排列，桌面端横向排列 -->
        <div class="selector-container">
          <!-- 单词库选择 -->
          <div class="form-selector">
            <label class="block text-sm font-medium text-gray-700">选择单词文件：</label>
            <div class="select-wrapper">
              <select id="wordFileSelect" class="custom-select">
                <option value="default">默认单词库</option>
                <option value="two">二年级单词</option>
                <option value="threesh">三年级上单词</option>
                <option value="basic">新概念1词库</option>
              </select>
            </div>
          </div>
          
          <!-- 课时选择 -->
          <div class="form-selector">
            <label class="block text-sm font-medium text-gray-700">选择课时：</label>
            <div class="select-wrapper">
              <select id="lessonSelect" class="custom-select">
                <option value="">请先选择单词库</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- 操作按钮区域 -->
        <div class="flex flex-wrap gap-2 mb-2">
          <!-- 课时统计信息 -->
          <div id="lessonStats" class="flex-1 flex items-center justify-center sm:justify-end text-sm text-gray-600">
            <span id="statsInfo" class="hidden sm:inline-flex items-center">
              <i class="fa fa-book text-primary mr-1"></i>
              <span>总课时：--</span>
              <span class="mx-2">|</span>
              <span>总单词：--</span>
            </span>
          </div>
        </div>
        
        <!-- 加载状态提示 -->
        <div id="fileNotification" class="mt-1 text-sm text-gray-600"></div>
        <!-- 保存状态提示 -->
        <div id="saveStatus" class="text-xs text-gray-500 mt-1"></div>
      </div>


      <!-- 游戏内容区域 -->
      <div id="content" class="space-y-5">
        <!-- 关卡和题目信息 -->
        <div class="animate-slide-up">
          <div id="instruction" class="text-lg font-semibold text-gray-800 mb-1"></div>
          <div id="stats" class="flex flex-wrap gap-2 text-sm text-gray-600"></div>
        </div>


        <!-- 单词信息 -->
        <div class="bg-blue-50 rounded-lg p-4 mb-5 animate-slide-up" style="animation-delay: 0.1s">
          <div id="question" class="text-base font-medium text-gray-800 mb-2"></div>
          <div id="definition" class="text-lg text-primary font-medium mb-1"></div>
          <div id="phonetic" class="text-base text-indigo-500 italic"></div>
        </div>


        <!-- 单词输入区域 -->
        <div class="flex justify-center mb-5 animate-slide-up" style="animation-delay: 0.2s">
          <div id="letterBox" class="flex gap-2 flex-wrap justify-center"></div>
        </div>


        <!-- 操作按钮 - 移动端优化布局 -->
        <div class="mb-5 animate-slide-up" style="animation-delay: 0.3s">
          <div class="btn-group mb-2">
            <button onclick="prevQuestion()" id="prevBtn" class="game-btn bg-gray-200 text-gray-700 focus:ring-gray-400">
              <i class="fa fa-arrow-left mr-1"></i> 上一题
            </button>
            <button onclick="toggleListening()" id="startReadingBtn" class="game-btn bg-orange-500 text-white focus:ring-orange-500">
              <i class="fa fa-microphone mr-1"></i> 开始朗读
            </button>
          </div>
          <div class="btn-group">
            <button onclick="readWord()" class="game-btn bg-primary text-white focus:ring-primary">
              <i class="fa fa-volume-up mr-1"></i> 听单词
            </button>
            <button onclick="showMistakes()" class="game-btn bg-green-500 text-white focus:ring-green-500">
              <i class="fa fa-book mr-1"></i> 查看错题本
            </button>
          </div>
          <div class="btn-group mt-2">
            <button onclick="submitAnswer()" id="nextBtn" class="game-btn bg-gray-200 text-gray-700 focus:ring-gray-400">
              跳过此题 <i class="fa fa-arrow-right ml-1"></i>
            </button>
            <button onclick="resetProgress()" class="game-btn bg-gray-200 text-gray-700 focus:ring-gray-400 flex-1 sm:flex-none min-w-[120px]">
              <i class="fa fa-refresh mr-1"></i> 重置进度
            </button>
            <button onclick="exitReview()" class="game-btn bg-green-500 text-white focus:ring-green-500" style="display:none">
              <i class="fa fa-arrow-left mr-1"></i> 返回闯关
            </button>
            <button onclick="nextQuestion()" id="continueBtn" class="game-btn bg-secondary text-white focus:ring-secondary" style="display:none">
              <i class="fa fa-arrow-right mr-1"></i> 继续下一题
            </button>
          </div>
        </div>


        <!-- 相似度指示器 -->
        <div id="similarityMeter" class="progress-bar mb-5 animate-slide-up" style="animation-delay: 0.4s; display: none">
          <div class="progress-fill bg-primary" id="similarityFill"></div>
        </div>


        <!-- 选项区域 -->
        <div id="options" class="space-y-2 animate-slide-up" style="animation-delay: 0.5s"></div>


        <!-- 结果区域 -->
        <div id="result" class="mt-4 p-4 rounded-lg text-center font-medium animate-slide-up" style="animation-delay: 0.6s"></div>


        <!-- 连续正确奖励区域 -->
        <div id="streakReward" class="hidden reward-card mt-5">
          <h3 class="font-bold text-lg text-orange-600 mb-2">连续正确奖励!</h3>
          <p id="rewardMessage" class="text-gray-700 mb-3"></p>
          <div class="flex justify-center">
            <button onclick="claimReward()" class="game-btn bg-orange-500 text-white focus:ring-orange-500">
              <i class="fa fa-gift mr-1"></i> 领取奖励
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- 底部信息 -->
    <div class="text-center text-gray-500 text-sm mt-6 animate-fade-in">
      <p>单词拼写游戏 V3.4 ©___在路上 | 系统学习英语词汇</p>
    </div>
  </div>


  <!-- 音频元素 -->
  <audio id="bgm" autoplay loop>
    <source src="https://cdn.pixabay.com/audio/2022/10/30/audio_46fdd201cc.mp3" type="audio/mpeg">
  </audio>
  <audio id="correct-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_e0b6f67a53.mp3"></audio>
  <audio id="wrong-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_2307f9b816.mp3"></think>
  <audio id="reward-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_139c839a53.mp3"></think>


  <!-- 连续正确提示 -->
  <div id="streakEffect" class="streak-effect"></div>


  <script>
    // 按课时组织的核心单词库
    const lessonWordLists = {
      "default": {
        name: "默认单词库",
        lessons: [
          {
            id: 1,
            name: "第1课：时间词汇",
            words: [
              {word:"morning", definition:"早晨；上午", phonetic:"/ˈmɔːnɪŋ/"},
              {word:"afternoon", definition:"午后；下午", phonetic:"/ˌɑːftəˈnuːn/"},
              {word:"evening", definition:"晚上；傍晚", phonetic:"/ˈiːvnɪŋ/"},
              {word:"night", definition:"夜间；夜晚", phonetic:"/naɪt/"},
              {word:"today", definition:"今天", phonetic:"/təˈdeɪ/"},
            ]
          },
          {
            id: 2,
            name: "第2课：日常用语",
            words: [
              {word:"fine", definition:"好的", phonetic:"/faɪn/"},
              {word:"thank", definition:"感谢", phonetic:"/θæŋk/"},
              {word:"goodbye", definition:"再见", phonetic:"/ˌɡʊdˈbaɪ/"},
              {word:"day", definition:"一天", phonetic:"/deɪ/"},
              {word:"hello", definition:"你好", phonetic:"/həˈləʊ/"},
            ]
          },
          {
            id: 3,
            name: "第3课：人物称呼",
            words: [
              {word:"Mrs", definition:"夫人；太太", phonetic:"/ˈmɪsɪz/"},
              {word:"Mr", definition:"先生", phonetic:"/ˈmɪstə(r)/"},
              {word:"Miss", definition:"小姐", phonetic:"/mɪs/"},
              {word:"friend", definition:"朋友", phonetic:"/frend/"},
              {word:"teacher", definition:"老师", phonetic:"/ˈtiːtʃə(r)/"},
            ]
          }
        ],
        isCustom: false,
        loaded: true
      },
      "two": {
        name: "二年级单词",
        lessons: [],
        isCustom: true,
        loaded: false
      },
       "threesh": {
        name: "三年级上单词",
        lessons: [],
        isCustom: true,
        loaded: false
      },
      "basic": {
        name: "新概念1词库",
        lessons: [],
        isCustom: true,
        loaded: false
      }
    };


    // 关卡谜题（扩展到33题）
    const puzzleQuestions = [
      { question: "“日出大米”猜一个字？", options: ["明", "昌", "早", "亮"], answer: "昌" },
      { question: "什么东西越洗越脏？", options: ["衣服", "手", "水", "地板"], answer: "水" },
      { question: "哪种狗不会叫？", options: ["热狗", "藏獒", "哈士奇", "牧羊犬"], answer: "热狗" },
      { question: "“一加一”猜一个字？", options: ["二", "十", "王", "丰"], answer: "王" },
      { question: "什么东西有五个头，但人不觉得它怪？", options: ["手指", "蛇", "海星", "石头"], answer: "手指" },
      { question: "什么球不能踢？", options: ["足球", "地球", "篮球", "排球"], answer: "地球" },
      { question: "“一点一横长，一撇到南洋”猜一个字？", options: ["大", "天", "广", "厂"], answer: "广" },
      { question: "什么东西晚上才会长出尾巴？", options: ["流星", "月亮", "壁虎", "影子"], answer: "流星" },
      { question: "什么水果视力最差？", options: ["苹果", "香蕉", "芒果", "葡萄"], answer: "芒果" },
      { question: "“三人同日来，喜见百花开”猜一个字？", options: ["春", "众", "晶", "森"], answer: "春" },
      { question: "什么东西越用越有钱？", options: ["钱包", "存钱罐", "银行卡", "聚宝盆"], answer: "存钱罐" },
      { question: "哪种鸡没有翅膀？", options: ["肉鸡", "田鸡", "野鸡", "火鸡"], answer: "田鸡" },
      { question: "“一边红，一边绿，一边喜雨，一边喜风”猜一个字？", options: ["秋", "明", "晴", "吵"], answer: "秋" },
      { question: "什么东西有腿却不能走路？", options: ["桌子", "狗", "蛇", "鱼"], answer: "桌子" },
      { question: "什么伞下雨天不能用？", options: ["太阳伞", "降落伞", "雨伞", "油纸伞"], answer: "降落伞" },
      { question: "“十字对十字，太阳对月亮”猜一个字？", options: ["朝", "萌", "冒", "明"], answer: "朝" },
      { question: "什么东西见者有份？", options: ["阳光", "礼物", "空气", "风景"], answer: "阳光" },
      { question: "什么马不会跑？", options: ["木马", "斑马", "河马", "宝马"], answer: "木马" },
      { question: "“有心走不快，见水装不完，长草难收拾”猜一个字？", options: ["曼", "慢", "漫", "蔓"], answer: "曼" },
      { question: "什么东西越剪越长？", options: ["绳子", "头发", "布料", "指甲"], answer: "头发" },
      { question: "什么瓜不能吃？", options: ["西瓜", "黄瓜", "傻瓜", "冬瓜"], answer: "傻瓜" },
      { question: "“有头无颈，有眼无眉”猜一种动物？", options: ["鱼", "蛇", "青蛙", "蚯蚓"], answer: "鱼" },
      { question: "什么东西能载万吨货物，却载不动一粒沙子？", options: ["船", "车", "飞机", "水"], answer: "水" },
      { question: "什么书你不可能在书店买到？", options: ["漫画书", "遗书", "故事书", "教科书"], answer: "遗书" },
      { question: "“七十二小时”猜一个字？", options: ["晶", "明", "早", "旭"], answer: "晶" },
      { question: "什么东西天气越热，它爬得越高？", options: ["温度计", "太阳", "气球", "冰淇淋"], answer: "温度计" },
      { question: "什么笔不能写字？", options: ["毛笔", "钢笔", "电笔", "铅笔"], answer: "电笔" },
      { question: "“一加一不是二”猜一个字？", options: ["王", "丰", "田", "由"], answer: "王" },
      { question: "什么东西别人请你吃，但你自己还要付钱？", options: ["官司", "饭局", "零食", "早餐"], answer: "官司" },
      { question: "什么牛不吃草？", options: ["水牛", "黄牛", "蜗牛", "奶牛"], answer: "蜗牛" },
      { question: "什么东西越擦越黑？", options: ["黑板", "镜子", "皮鞋", "玻璃"], answer: "黑板" },
      { question: "什么球离你最近？", options: ["足球", "地球", "眼球", "气球"], answer: "眼球" },
      { question: "“一人一张口，下面长只手”猜一个字？", options: ["拿", "合", "哈", "答"], answer: "拿" },
      { question: "什么东西没脚走天下？", options: ["船", "蛇", "路", "邮票"], answer: "邮票" },
      {question: "什么东西越洗越脏？", options: ["衣服", "手", "水", "地板"], answer: "水"}
    ];


    // 奖励谜题（连续答对5题时使用）
    const rewardPuzzles = [
      { question: "什么水果有视力问题？", options: ["苹果", "香蕉", "芒果", "葡萄"], answer: "芒果" },
      { question: "什么东西有头无颈？", options: ["酒瓶", "铅笔", "石头", "桌子"], answer: "酒瓶" },
      { question: "什么东西人们在不停地吃它，却永远吃不饱？", options: ["空气", "水", "零食", "知识"], answer: "空气" },
      { question: "什么东西能加不能减？", options: ["年龄", "体重", "金钱", "分数"], answer: "年龄" },
      { question: "什么东西越生气，它就越大？", options: ["脾气", "气球", "火焰", "海浪"], answer: "脾气" }
    ];


    // 发音变体（用于容错）
    const pronunciationVariants = {
      "morning": ["mornin", "mornning"],
      "afternoon": ["afternun", "afternooon"],
      "evening": ["evenin", "evenning"],
      "hello": ["hallo", "hellow"],
    };


    // 连续正确奖励配置（已删除3题星星奖励）
    const streakRewards = {
      5: {
        description: "挑战奖励谜题赢取额外积分！",
        action: () => {
          // 触发奖励谜题
          showRewardPuzzle();
          return "完成谜题获得额外奖励！";
        }
      }
    };


    // 游戏核心变量 - 修复：添加currentFile和currentLessonId的保存
    let gameData = JSON.parse(localStorage.getItem('wordGameData')) || {
      currentFile: "default",  // 新增：当前单词库文件
      currentLessonId: 1,      // 新增：当前课时ID
      currentIndex: 0, 
      lessonStars: {}, // 按文件和课时保存星级 {file: {lessonId: stars}}
      wrongList: {},   // 按文件保存错题 {file: [words]}
      puzzleQuestionsUsed: {} // 按文件保存已使用的谜题 {file: [indices]}
    };


    // 内存变量 - 修复：从gameData中获取currentFile和currentLessonId
    let { currentFile, currentLessonId, currentIndex, lessonStars, wrongList, puzzleQuestionsUsed } = gameData;
    let inPuzzle = false;
    let inRewardPuzzle = false; // 新增：标记是否在奖励谜题中
    let isReviewMode = false;
    let currentStreak = 0;
    let currentReviewIndex = 0;
    let recognition;
    let isListening = false;
    let answerCorrect = false; // 标记答案是否正确
    let speechSynthAvailable = false; // 语音合成可用状态
    let rewardPuzzleIndex = -1; // 记录当前奖励谜题索引


    // DOM元素缓存
    const dom = {
      instruction: document.getElementById("instruction"),
      question: document.getElementById("question"),
      result: document.getElementById("result"),
      options: document.getElementById("options"),
      definition: document.getElementById("definition"),
      phonetic: document.getElementById("phonetic"),
      letterBox: document.getElementById("letterBox"),
      stats: document.getElementById("stats"),
      nextBtn: document.getElementById("nextBtn"),
      prevBtn: document.getElementById("prevBtn"),
      startReadingBtn: document.getElementById("startReadingBtn"),
      fileNotification: document.getElementById("fileNotification"),
      similarityMeter: document.getElementById("similarityMeter"),
      similarityFill: document.getElementById("similarityFill"),
      streakReward: document.getElementById("streakReward"),
      rewardMessage: document.getElementById("rewardMessage"),
      correctSound: document.getElementById("correct-sound"),
      wrongSound: document.getElementById("wrong-sound"),
      rewardSound: document.getElementById("reward-sound"),
      readWordBtn: document.querySelector('button[onclick="readWord()"]'),
      lessonSelect: document.getElementById("lessonSelect")
    };


    // 初始化
    function init() {
      // 初始化事件监听
      document.getElementById("wordFileSelect").addEventListener('change', loadSelectedWordFile);
      dom.lessonSelect.addEventListener('change', changeLesson);
      
      // 加载默认文件
      loadSelectedWordFile();
      initSpeechRecognition();
      checkSpeechSynthesis();
      
      // 设置单词库选择器的初始值
      document.getElementById("wordFileSelect").value = currentFile;
    }


    // 检查语音合成支持
    function checkSpeechSynthesis() {
      if ('speechSynthesis' in window) {
        speechSynthAvailable = true;
        dom.readWordBtn.disabled = false;
        dom.readWordBtn.title = "";
      } else {
        speechSynthAvailable = false;
        dom.readWordBtn.disabled = true;
        dom.readWordBtn.title = "您的浏览器不支持语音合成";
      }
    }


    // 加载单词文件
    function loadSelectedWordFile() {
      const selectedFile = document.getElementById("wordFileSelect").value;
      if (selectedFile === currentFile && lessonWordLists[currentFile].loaded) return;
      
      saveCurrentProgress();  // 保存当前进度
      currentFile = selectedFile;  // 更新当前文件
      dom.fileNotification.textContent = "";
      
      const file = lessonWordLists[currentFile];
	  
      // 新增：切换文件时重置当前课时ID
      if (file.lessons.length > 0) {
        currentLessonId = file.lessons[0].id;
        currentIndex = 0;
      }
      
      // 初始化当前文件的错题列表（如果不存在）
      if (!wrongList[currentFile]) {
        wrongList[currentFile] = [];
      }
      
      // 初始化当前文件的谜题使用记录（如果不存在）
      if (!puzzleQuestionsUsed[currentFile]) {
        puzzleQuestionsUsed[currentFile] = [];
      }
      
      // 如果文件已加载，直接更新界面
      if (file.loaded) {
        updateLessonSelector();
        return;
      }
      
      // 否则加载文件
      dom.fileNotification.textContent = `正在加载 ${file.name}...`;
      
      // 词库文件路径
      const fileName = {
        "two": "two_words.txt",
        "threesh": "threeshang_words.txt",
        "basic": "basic_words.txt"
      }[currentFile];


      // 读取并解析带课时的TXT文件
      fetch(fileName)
        .then(response => {
          if (!response.ok) throw new Error("文件不存在或加载失败");
          return response.text();
        })
        .then(text => {
          const lessons = parseLessonFile(text);
          
          if (lessons.length === 0) {
            throw new Error("未解析到有效课时，请检查文件格式");
          }
          
          // 加载成功，更新数据
          lessonWordLists[currentFile].lessons = lessons;
          lessonWordLists[currentFile].loaded = true;
          dom.fileNotification.textContent = `加载成功！共 ${lessons.length} 个课时，${lessons.reduce((total, lesson) => total + lesson.words.length, 0)} 个单词`;
          
          // 更新统计信息显示
          document.querySelector('#statsInfo span:first-of-type').textContent = `总课时：${lessons.length}`;
          document.querySelector('#statsInfo span:last-of-type').textContent = `总单词：${lessons.reduce((total, lesson) => total + lesson.words.length, 0)}`;
          
          // 更新课时选择器
          updateLessonSelector();
        })
        .catch(error => {
          dom.fileNotification.textContent = `加载失败：${error.message}`;
          console.error("词库加载错误：", error);
        });
    }


    // 解析带课时的词库文件
function parseLessonFile(text) {
  const lessons = [];
  let currentLesson = { id: 1, name: "第1课", words: [] };
  let currentLessonId = 1;
  let currentLessonName = `第${currentLessonId}课`;


  // 按行分割，过滤空行和无效行
  const lines = text.split('\n')
    .map(line => line.trim())
    .filter(line => line && !line.startsWith('//')); // 忽略注释行


  lines.forEach(line => {
    // 检测课时分隔符（支持"LessonX"和"LessonX:XXXXXX"两种格式）
    const lessonMatch = line.match(/Lesson\s*(\d+)\s*:?\s*(.*)/i);
    if (lessonMatch) {
      // 保存当前课时（如果有单词）
      if (currentLesson.words.length > 0) {
        lessons.push(currentLesson);
      }
      // 创建新课时
      currentLessonId = parseInt(lessonMatch[1]);
      currentLessonName = lessonMatch[2] ? lessonMatch[2] : `第${currentLessonId}课`;
      currentLesson = {
        id: currentLessonId,
        name: currentLessonName,
        words: []
      };
    } else {
      // 解析单词行
      const parts = line.split(',').map(p => p.trim());
      if (parts.length >= 2) {
        // 支持两种格式：
        // 1. word,definition,phonetic
        // 2. 序号,word,definition,phonetic
        const wordIndex = parts[0].match(/^\d+$/) ? 1 : 0; // 判断第一部分是否为数字
        if (wordIndex < parts.length) {
          currentLesson.words.push({
            word: parts[wordIndex],
            definition: parts[wordIndex + 1],
            phonetic: parts[wordIndex + 2] || '无'
          });
        }
      }
    }
  });


  // 添加最后一个课时
  if (currentLesson.words.length > 0) {
    lessons.push(currentLesson);
  }


  return lessons;
}


    // 更新课时选择器
    function updateLessonSelector() {
      const file = lessonWordLists[currentFile];
      const lessonSelect = dom.lessonSelect;
      
      // 清空现有选项
      lessonSelect.innerHTML = "";
      
      // 添加课时选项
      file.lessons.forEach(lesson => {
        const option = document.createElement("option");
        option.value = lesson.id;
        option.textContent = `${lesson.name} (${lesson.words.length}个单词)`;
        lessonSelect.appendChild(option);
      });
      
      // 设置当前课时（如果存在）
      const hasCurrentLesson = file.lessons.some(lesson => lesson.id === currentLessonId);
      if (!hasCurrentLesson && file.lessons.length > 0) {
        currentLessonId = file.lessons[0].id;
        currentIndex = 0;
      }
      
      lessonSelect.value = currentLessonId;
      
      // 加载当前课时
      loadCurrentLesson();
    }


    // 切换课时
    function changeLesson() {
      const selectedLessonId = parseInt(dom.lessonSelect.value);
      if (selectedLessonId === currentLessonId) return;
      
      saveCurrentProgress();  // 保存当前进度
      currentLessonId = selectedLessonId;  // 更新当前课时
      currentIndex = 0;  // 切换课时时重置题目索引
      
      loadCurrentLesson();
    }


    // 更新统计信息
    function updateStats() {
      const file = lessonWordLists[currentFile];
      const lesson = getCurrentLesson();
      
      // 初始化当前文件的错题列表（如果不存在）
      wrongList[currentFile] = wrongList[currentFile] || [];
      
      dom.stats.innerHTML = `
        <div><i class="fa fa-check-circle text-green-500 mr-1"></i> 正确：<b>${getCorrectCount()}</b></div>
        <div><i class="fa fa-times-circle text-red-500 mr-1"></i> 错误：<b>${wrongList[currentFile].length}</b></div>
        <div><i class="fa fa-book text-primary mr-1"></i> 进度：<b>${currentIndex + 1}/${lesson.words.length}</b></div>
      `;
    }


    // 获取当前课时的正确单词数
    function getCorrectCount() {
      const lesson = getCurrentLesson();
      const lessonWords = lesson.words.map(word => word.word.toLowerCase());
      const wrongWords = (wrongList[currentFile] || []).map(word => word.word.toLowerCase());
      
      // 计算正确数 = 已完成单词数 - 其中的错误单词数
      return Math.min(currentIndex, lesson.words.length) - 
             lessonWords.slice(0, currentIndex).filter(word => wrongWords.includes(word)).length;
    }


    // 获取当前课时
    function getCurrentLesson() {
      return lessonWordLists[currentFile].lessons.find(lesson => lesson.id === currentLessonId) || 
             lessonWordLists[currentFile].lessons[0];
    }


    // 加载当前课时内容
    function loadCurrentLesson() {
      // 重置UI状态
      dom.question.textContent = "";
      dom.result.textContent = "";
      dom.options.innerHTML = "";
      dom.letterBox.innerHTML = "";
      dom.similarityMeter.style.display = "none";
      dom.streakReward.classList.add("hidden");
      dom.nextBtn.style.display = "inline-block";
      document.getElementById("continueBtn").style.display = "none";
      answerCorrect = false;
      
      // 确保当前文件和课时有效
      const file = lessonWordLists[currentFile];
      if (!file.loaded || file.lessons.length === 0) {
        dom.instruction.textContent = "请先选择有效的单词库和课时";
        dom.definition.textContent = "";
        dom.phonetic.textContent = "";
        return;
      }
      
      // 获取当前课时
      const lesson = getCurrentLesson();
      if (!lesson) {
        dom.instruction.textContent = "未找到指定课时";
        dom.definition.textContent = "";
        dom.phonetic.textContent = "";
        return;
      }
      
      // 错题回顾模式
      if (isReviewMode) {
        document.querySelector('button[onclick="exitReview()"]').style.display = "inline-block";
        const fileWrongList = wrongList[currentFile] || [];
        
        if (fileWrongList.length === 0) {
          dom.instruction.textContent = "🎉 恭喜你攻克了所有错题！";
          dom.definition.textContent = "继续加油哦！";
          dom.phonetic.textContent = "";
          dom.nextBtn.style.display = "none";
          dom.prevBtn.style.display = "none";
          return;
        }
        
        currentReviewIndex = Math.min(currentReviewIndex, fileWrongList.length - 1);
        const wordObj = fileWrongList[currentReviewIndex];
        dom.instruction.innerHTML = `<span class="level-badge">错题回顾</span> 第 ${currentReviewIndex + 1}/${fileWrongList.length} 题`;
        dom.definition.textContent = `中文提示：${wordObj.definition}`;
        dom.phonetic.textContent = `音标：${wordObj.phonetic || '无'}`;
        generateInputBoxes(wordObj);
        return;
      }
      
      // 正常闯关模式
      document.querySelector('button[onclick="exitReview()"]').style.display = "none";
      
      // 检查是否需要显示谜题（完成课时后）
      if (currentIndex >= lesson.words.length && !inPuzzle && !inRewardPuzzle) {
        showPuzzle();
        return;
      }
      
      // 显示当前单词
      const wordObj = lesson.words[currentIndex];
      dom.instruction.innerHTML = `<span class="level-badge">${lesson.name}</span> 第 ${currentIndex + 1}/${lesson.words.length} 词`;
      dom.definition.textContent = `中文提示：${wordObj.definition}`;
      dom.phonetic.textContent = `音标：${wordObj.phonetic || '无'}`;
      generateInputBoxes(wordObj);
      
      // 自动朗读单词
      if (speechSynthAvailable) {
        setTimeout(readWord, 500);
      }
      
      // 更新统计
      updateStats();
      
      // 更新按钮状态
      dom.nextBtn.textContent = isReviewMode ? "下一个错题" : "跳过此题";
      dom.prevBtn.disabled = isReviewMode ? currentReviewIndex <= 0 : currentIndex <= 0;
    }


    // 生成输入框
    function generateInputBoxes(wordObj) {
      // 清空现有内容
      dom.letterBox.innerHTML = "";
      
      // 生成所有字母的输入框
      for (let i = 0; i < wordObj.word.length; i++) {
        const input = document.createElement("input");
        input.type = "text";
        input.maxLength = 1;
        input.className = "word-input";
        input.dataset.index = i;
        // 确保输入转换为小写
        input.addEventListener('input', function() {
          if (this.value) {
            this.value = this.value.toLowerCase();
          }
        });
        addInputListeners(input);
        dom.letterBox.appendChild(input);
      }
      
      // 聚焦第一个输入框
      dom.letterBox.querySelector("input")?.focus();
    }


    // 输入框事件监听
    function addInputListeners(input) {
      // 输入后自动跳到下一个
      input.addEventListener('input', function() {
        if (this.value) {
          const next = this.nextElementSibling;
          if (next?.tagName === "INPUT") {
            next.focus();
          } else {
            checkAnswer(); // 最后一个输入框填满后自动检查
          }
        }
      });


      // 退格键处理
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && !this.value) {
          const prev = this.previousElementSibling;
          if (prev?.tagName === "INPUT") {
            prev.focus();
          }
        }
      });
    }


    // 检查答案
    function checkAnswer() {
      // 获取当前单词
      const wordObj = isReviewMode 
        ? (wrongList[currentFile] || [])[currentReviewIndex]
        : getCurrentLesson().words[currentIndex];
      
      if (!wordObj) return;
      
      // 获取用户输入（确保全部转为小写）
      const inputs = dom.letterBox.querySelectorAll("input");
      let userAnswer = "";
      inputs.forEach(input => userAnswer += (input.value || '').toLowerCase());


      // 检查是否填满
      if (userAnswer.length !== wordObj.word.length) return;


      // 相似度计算
      dom.similarityMeter.style.display = "block";
      const similarity = calculateSimilarity(userAnswer, wordObj.word.toLowerCase());
      dom.similarityFill.style.width = `${similarity * 100}%`;


      // 判断对错
      const isCorrect = userAnswer === wordObj.word.toLowerCase() || 
        (pronunciationVariants[wordObj.word.toLowerCase()]?.includes(userAnswer) ?? false);


      // 标记输入框状态
      inputs.forEach((input, i) => {
        const correctChar = wordObj.word[i].toLowerCase();
        input.className = `word-input ${input.value.toLowerCase() === correctChar ? 'correct' : 'wrong'}`;
      });


      // 处理结果
      if (isCorrect) {
        dom.result.className = "mt-4 p-4 rounded-lg bg-green-100 text-green-800";
        dom.result.textContent = `🎉 正确！单词：${wordObj.word}`;
        dom.correctSound.play();
        answerCorrect = true;
        document.getElementById("continueBtn").style.display = "inline-block";
        dom.nextBtn.style.display = "none";
        currentStreak++;
        
        // 提示用户朗读单词
        setTimeout(() => {
          dom.result.textContent += " 请朗读单词以继续下一题";
          dom.startReadingBtn.focus();
        }, 500);
        
        // 检查连续正确奖励
        if (streakRewards[currentStreak]) {
          showReward(currentStreak);
        }
      } else {
        dom.result.className = "mt-4 p-4 rounded-lg bg-red-100 text-red-800";
        dom.result.textContent = `❌ 错误！正确单词：${wordObj.word}`;
        dom.wrongSound.play();
        currentStreak = 0;
        
        // 添加到错题本（去重）
        wrongList[currentFile] = wrongList[currentFile] || [];
        if (!wrongList[currentFile].some(w => w.word.toLowerCase() === wordObj.word.toLowerCase())) {
          wrongList[currentFile].push(wordObj);
        }


        // 高亮错误字母1秒后清空
        setTimeout(() => {
          const inputs = dom.letterBox.querySelectorAll("input");
          inputs.forEach((input, i) => {
            const correctChar = wordObj.word[i].toLowerCase();
            if (input.value.toLowerCase() !== correctChar) {
              input.classList.add('highlight');
            }
          });
          
          // 1秒后清空输入框
          setTimeout(() => {
            inputs.forEach(input => {
              input.value = '';
              input.className = 'word-input';
              input.classList.remove('highlight');
            });
            dom.letterBox.querySelector("input")?.focus();
          }, 1000);
        }, 500);
      }
      
      // 保存进度
      saveCurrentProgress();
      updateStats();
    }


    // 显示连续正确效果
    function showStreakEffect() {
      const streakEl = document.getElementById("streakEffect");
      streakEl.textContent = `+${currentStreak} 连击！`;
      streakEl.style.display = "block";
      setTimeout(() => {
        streakEl.style.display = "none";
      }, 1000);
    }


    // 下一题处理
    function nextQuestion() {
      // 保存当前进度
      saveCurrentProgress();
      
      // 错题回顾模式
      if (isReviewMode) {
        currentReviewIndex++;
        loadCurrentLesson();
        return;
      }
      
      // 正常模式
      currentIndex++;
      
      // 检查是否完成当前课时
      const lesson = getCurrentLesson();
      if (currentIndex >= lesson.words.length && !inPuzzle && !inRewardPuzzle) {
        // 显示谜题
        showPuzzle();
      } else {
        // 继续当前课时
        loadCurrentLesson();
      }
    }


    // 上一题
    function prevQuestion() {
      if (isReviewMode) {
        if (currentReviewIndex > 0) {
          currentReviewIndex--;
        }
      } else if (currentIndex > 0) {
        currentIndex--;
        // 调整连续正确计数
        if (currentStreak > 0) currentStreak--;
      }
      
      loadCurrentLesson();
    }


    // 跳过当前题
    function submitAnswer() {
      if (isReviewMode) {
        currentReviewIndex++;
        loadCurrentLesson();
        return;
      }


      if (inPuzzle) {
        // 谜题跳过，进入下一课
        const lessons = lessonWordLists[currentFile].lessons;
        const currentLessonIndex = lessons.findIndex(lesson => lesson.id === currentLessonId);
        
        if (currentLessonIndex + 1 < lessons.length) {
          currentLessonId = lessons[currentLessonIndex + 1].id;
        } else {
          currentLessonId = lessons[0].id; // 循环到第一课时
        }
        
        currentIndex = 0;
        inPuzzle = false;
        saveCurrentProgress();
        loadCurrentLesson();
        return;
      }
      
      // 奖励谜题跳过
      if (inRewardPuzzle) {
        inRewardPuzzle = false;
        nextQuestion();
        return;
      }


      // 正常题跳过（加入错题）
      const lesson = getCurrentLesson();
      const currentWord = lesson.words[currentIndex];
      
      wrongList[currentFile] = wrongList[currentFile] || [];
      if (!wrongList[currentFile].some(w => w.word.toLowerCase() === currentWord.word.toLowerCase())) {
        wrongList[currentFile].push(currentWord);
      }
      
      currentStreak = 0;
      currentIndex++;
      saveCurrentProgress();
      loadCurrentLesson();
    }


    // 显示课时完成谜题
    function showPuzzle() {
      inPuzzle = true;
      const lesson = getCurrentLesson();
      
      // 初始化当前文件的谜题使用记录
      puzzleQuestionsUsed[currentFile] = puzzleQuestionsUsed[currentFile] || [];
      
      // 选择未使用的谜题
      let availablePuzzles = puzzleQuestions.filter((_, index) => 
        !puzzleQuestionsUsed[currentFile].includes(index)
      );
      
      // 如果所有谜题都用过了，重置
      if (availablePuzzles.length === 0) {
        availablePuzzles = puzzleQuestions;
        puzzleQuestionsUsed[currentFile] = [];
      }
      
      // 随机选择一个谜题
      const puzzleIndex = Math.floor(Math.random() * availablePuzzles.length);
      const puzzle = availablePuzzles[puzzleIndex];
      puzzleQuestionsUsed[currentFile].push(puzzleQuestions.indexOf(puzzle));


      // 显示谜题
      dom.instruction.innerHTML = `<span class="level-badge">${lesson.name} 完成挑战</span> 恭喜完成本课时，来挑战一个小谜题吧！`;
      dom.question.textContent = puzzle.question;
      dom.definition.textContent = "请选择正确答案：";
      dom.phonetic.textContent = "";
      dom.letterBox.innerHTML = "";


      // 生成选项
      puzzle.options.forEach(option => {
        const btn = document.createElement("button");
        btn.className = "game-btn bg-gray-200 text-gray-700 w-full text-left mb-2";
        btn.textContent = option;
        btn.onclick = () => checkPuzzleAnswer(puzzle, option, false);
        dom.options.appendChild(btn);
      });
    }


    // 显示连续答对奖励谜题
    function showRewardPuzzle() {
      inRewardPuzzle = true;
      const lesson = getCurrentLesson();
      
      // 随机选择一个奖励谜题
      rewardPuzzleIndex = Math.floor(Math.random() * rewardPuzzles.length);
      const puzzle = rewardPuzzles[rewardPuzzleIndex];


      // 显示谜题
      dom.instruction.innerHTML = `<span class="level-badge">🎉 连续答对奖励</span> 恭喜连续答对5题！来挑战一个奖励谜题吧！`;
      dom.question.textContent = puzzle.question;
      dom.definition.textContent = "请选择正确答案：";
      dom.phonetic.textContent = "";
      dom.letterBox.innerHTML = "";
      dom.streakReward.classList.add("hidden");


      // 生成选项
      puzzle.options.forEach(option => {
        const btn = document.createElement("button");
        btn.className = "game-btn bg-yellow-200 text-yellow-800 w-full text-left mb-2";
        btn.textContent = option;
        btn.onclick = () => checkPuzzleAnswer(puzzle, option, true);
        dom.options.appendChild(btn);
      });
    }


    // 检查谜题答案
    function checkPuzzleAnswer(puzzle, selected, isRewardPuzzle) {
      const buttons = dom.options.querySelectorAll("button");
      buttons.forEach(btn => {
        btn.disabled = true;
        if (btn.textContent === puzzle.answer) {
          btn.className = "game-btn bg-green-500 text-white w-full text-left mb-2";
        } else if (btn.textContent === selected) {
          btn.className = "game-btn bg-red-500 text-white w-full text-left mb-2";
        }
      });


      // 处理结果
      if (selected === puzzle.answer) {
        dom.result.className = "mt-4 p-4 rounded-lg bg-green-100 text-green-800";
        dom.result.textContent = "🎉 恭喜你答对了！获得额外奖励！";
        dom.correctSound.play();
        
        // 奖励星星
        lessonStars[currentFile] = lessonStars[currentFile] || {};
        lessonStars[currentFile][currentLessonId] = Math.min((lessonStars[currentFile][currentLessonId] || 0) + 1, 3);
        dom.result.textContent += ` 当前课时星星：${lessonStars[currentFile][currentLessonId]}/3 ⭐`;
      } else {
        dom.result.className = "mt-4 p-4 rounded-lg bg-red-100 text-red-800";
        dom.result.textContent = `❌ 正确答案是：${puzzle.answer}`;
        dom.wrongSound.play();
      }


      // 保存进度
      saveCurrentProgress();
      
      // 非奖励谜题（课时完成谜题）的处理
      if (!isRewardPuzzle) {
        // 2秒后进入下一课
        setTimeout(() => {
          const lessons = lessonWordLists[currentFile].lessons;
          const currentLessonIndex = lessons.findIndex(lesson => lesson.id === currentLessonId);
          
          // 进入下一课
          if (currentLessonIndex + 1 < lessons.length) {
            currentLessonId = lessons[currentLessonIndex + 1].id;
          } else {
            // 如果是最后一课，循环到第一课时
            currentLessonId = lessons[0].id;
            dom.result.textContent += " 恭喜你完成了所有课时！将从第一课时重新开始。";
          }
          
          currentIndex = 0;
          inPuzzle = false;
          loadCurrentLesson();
          
          // 更新课时选择器
          dom.lessonSelect.value = currentLessonId;
        }, 2000);
      } else {
        // 奖励谜题的处理
        setTimeout(() => {
          inRewardPuzzle = false;
          nextQuestion();
        }, 2000);
      }
    }


    // 语音识别初始化
    function initSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        dom.startReadingBtn.disabled = true;
        dom.startReadingBtn.title = "你的浏览器不支持语音识别";
        return;
      }


      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;


      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.toLowerCase();
        
        // 获取当前单词（转为小写）
        const currentWord = isReviewMode 
          ? (wrongList[currentFile] || [])[currentReviewIndex].word.toLowerCase()
          : getCurrentLesson().words[currentIndex].word.toLowerCase();
        
        // 检查语音是否匹配单词（包括变体）
        const variants = [currentWord, ...(pronunciationVariants[currentWord] || [])];
        const isMatch = variants.some(variant => 
          transcript.includes(variant) || variant.includes(transcript)
        );


        // 处理识别结果
        if (isMatch) {
          if (answerCorrect) {
            dom.result.textContent = `🎉 语音识别成功！单词：${currentWord}`;
            setTimeout(() => {
              // 移除错题（如果在复习模式）
              if (isReviewMode) {
                wrongList[currentFile] = (wrongList[currentFile] || []).filter(
                  w => w.word.toLowerCase() !== currentWord
                );
              }
              
              nextQuestion();
            }, 1000);
          } else {
            dom.result.textContent = `语音识别：${transcript}，请先正确拼写单词`;
          }
        } else {
          dom.result.textContent = `未能识别："${transcript}"，请尝试再次朗读 "${currentWord}"`;
        }
      };


      recognition.onend = () => {
        isListening = false;
        dom.startReadingBtn.textContent = "开始朗读";
        dom.startReadingBtn.classList.remove("listening");
      };
    }


    // 切换语音识别状态
    function toggleListening() {
      if (!recognition) return;
      
      if (isListening) {
        recognition.stop();
        isListening = false;
        dom.startReadingBtn.textContent = "开始朗读";
        dom.startReadingBtn.classList.remove("listening");
      } else {
        recognition.start();
        isListening = true;
        dom.startReadingBtn.textContent = "正在聆听...";
        dom.startReadingBtn.classList.add("listening");
        dom.result.textContent = "请朗读单词...";
      }
    }


    // 保存当前进度 - 修复：添加currentFile和currentLessonId的保存
    function saveCurrentProgress() {
      gameData = { 
        currentFile,          // 保存当前单词库文件
        currentLessonId,      // 保存当前课时ID
        currentIndex, 
        lessonStars, 
        wrongList, 
        puzzleQuestionsUsed 
      };
      
      try {
        localStorage.setItem('wordGameData', JSON.stringify(gameData));
        document.getElementById('saveStatus').textContent = "进度已自动保存";
      } catch (e) {
        console.error("无法保存进度:", e);
        document.getElementById('saveStatus').textContent = "进度保存失败，请启用本地存储";
      }
    }


    // 显示奖励
    function showReward(streak) {
      const reward = streakRewards[streak];
      dom.rewardMessage.innerHTML = `${reward.description}<br>${reward.action()}`;
      dom.streakReward.classList.remove("hidden");
      dom.rewardSound.play();
      showStreakEffect();
    }


    // 领取奖励
    function claimReward() {
      // 如果是连续5题的奖励，直接触发奖励谜题
      if (currentStreak === 5) {
        dom.streakReward.classList.add("hidden");
        showRewardPuzzle();
      } else {
        dom.streakReward.classList.add("hidden");
      }
    }


    // 显示错题
    function showMistakes() {
      isReviewMode = true;
      currentReviewIndex = 0;
      loadCurrentLesson();
    }


    // 退出复习模式
    function exitReview() {
      isReviewMode = false;
      loadCurrentLesson();
    }


    // 重置进度
	function resetProgress() {
	  if (confirm(`确定要重置"${lessonWordLists[currentFile].name}"的所有进度吗？`)) {
		// 1. 彻底清除当前文件的所有数据
		lessonStars = {...lessonStars};
		delete lessonStars[currentFile]; // 清除当前文件星级
		
		wrongList = {...wrongList};
		wrongList[currentFile] = []; // 清空当前文件错题
		
		puzzleQuestionsUsed = {...puzzleQuestionsUsed};
		puzzleQuestionsUsed[currentFile] = []; // 清空已用谜题
		
		// 2. 重置所有进度变量
		currentIndex = 0;
		currentStreak = 0;
		answerCorrect = false;
		inPuzzle = false;
		inRewardPuzzle = false;
		isReviewMode = false;
		currentReviewIndex = 0;
		
		// 3. 重置当前课时为第一课时
		const file = lessonWordLists[currentFile];
		if (file.lessons.length > 0) {
		  currentLessonId = file.lessons[0].id;
		}
		
		// 4. 强制更新gameData并同步到本地存储
		gameData = {
		  currentFile,
		  currentLessonId,
		  currentIndex,
		  lessonStars,
		  wrongList,
		  puzzleQuestionsUsed
		};
		localStorage.removeItem('wordGameData');
		localStorage.setItem('wordGameData', JSON.stringify(gameData));
		
		// 5. 强制刷新课时选择器和界面
		document.getElementById("lessonSelect").value = currentLessonId;
		loadCurrentLesson();
		
		// 6. 显示重置成功提示
		dom.result.className = "mt-4 p-4 rounded-lg bg-blue-100 text-blue-800";
		dom.result.textContent = "✅ 进度已重置，从第一课时开始吧！";
	  }
	}


    // 语音朗读功能
    function readWord() {
      if (!speechSynthAvailable) return;
      
      // 停止任何正在进行的语音合成
      window.speechSynthesis.cancel();
      
      // 获取当前单词
      const currentWord = isReviewMode 
        ? (wrongList[currentFile] || [])[currentReviewIndex].word
        : getCurrentLesson().words[currentIndex].word;
      
      // 创建语音合成实例
      const utterance = new SpeechSynthesisUtterance(currentWord);
      utterance.lang = 'en-US';
      utterance.rate = 0.9; // 稍微降低语速，便于学习
      
      // 设置朗读完成后的回调
      utterance.onend = () => {
        console.log(`朗读完成: ${currentWord}`);
      };
      
      utterance.onerror = (event) => {
        console.error(`语音合成错误: ${event.error}`);
        dom.result.textContent = "语音合成出错，请稍后再试";
      };
      
      // 开始朗读
      window.speechSynthesis.speak(utterance);
    }


    // 计算字符串相似度
    function calculateSimilarity(s1, s2) {
      if (s1 === s2) return 1;
      const longer = s1.length > s2.length ? s1 : s2;
      const shorter = s1.length > s2.length ? s2 : s1;
      const longerLen = longer.length;
      if (longerLen === 0) return 1.0;
      
      return (longerLen - editDistance(longer, shorter)) / parseFloat(longerLen);
    }


    // 编辑距离算法
    function editDistance(s1, s2) {
      s1 = s1.toLowerCase();
      s2 = s2.toLowerCase();
      
      const costs = [];
      for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
          if (i === 0) costs[j] = j;
          else {
            if (j > 0) {
              let newValue = costs[j - 1];
              if (s1.charAt(i - 1) !== s2.charAt(j - 1))
                newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
              costs[j - 1] = lastValue;
              lastValue = newValue;
            }
          }
        }
        if (i > 0) costs[s2.length] = lastValue;
      }
      return costs[s2.length];
    }


    // 页面加载完成后初始化游戏
    window.onload = init;
  </script>
</body>
</html>
