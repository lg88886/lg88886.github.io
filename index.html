<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>单词拼写游戏V3.4 - 按课时学习</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6', // 主色调：蓝色
            secondary: '#10B981', // 辅助色：绿色
            accent: '#F59E0B', // 强调色：橙色
            danger: '#EF4444', // 错误色：红色
            neutral: '#6B7280', // 中性色：灰色
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          animation: {
            'pop': 'pop 0.3s ease',
            'streak': 'streak 1s forwards',
            'fade-in': 'fadeIn 0.5s ease',
            'slide-up': 'slideUp 0.5s ease-out',
            'highlight': 'highlight 1s ease',
          },
          keyframes: {
            pop: {
              '0%, 100%': { transform: 'scale(1)' },
              '50%': { transform: 'scale(1.1)' },
            },
            streak: {
              '0%': { opacity: '0', transform: 'translate(-50%, -20px)' },
              '50%': { opacity: '1', transform: 'translate(-50%, 0)' },
              '100%': { opacity: '0', transform: 'translate(-50%, 20px)' },
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            highlight: {
              '0%, 100%': { background: '#EF4444' },
              '50%': { background: '#f87171' },
            }
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .word-input {
        @apply w-12 h-12 sm:w-10 sm:h-10 rounded-md border-2 border-gray-300 text-center text-xl font-medium transition-all duration-300;
        text-transform: lowercase; /* 强制显示小写 */
      }
      .word-input::placeholder {
        text-transform: none; /* 确保占位符不受影响 */
      }
      .word-input:focus {
        @apply border-primary ring-2 ring-primary/30;
      }
      .word-input.correct {
        @apply border-secondary bg-green-50 animate-pop;
      }
      .word-input.wrong {
        @apply border-danger bg-red-50;
      }
      .fixed-letter {
        @apply w-12 h-12 sm:w-10 sm:h-10 rounded-md border-2 border-gray-300 bg-gray-100 text-gray-600 text-center text-xl font-medium flex items-center justify-center cursor-not-allowed;
      }
      .game-btn {
        @apply px-4 py-3 sm:px-5 sm:py-2.5 rounded-lg font-medium transition-all duration-300 hover:translate-y-[-2px] hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2;
      }
      .streak-effect {
        @apply fixed top-1/4 left-1/2 transform -translate-x-1/2 text-4xl font-bold text-accent opacity-0 pointer-events-none animate-streak;
      }
      .progress-bar {
        @apply h-2 rounded-full overflow-hidden bg-gray-200;
      }
      .progress-fill {
        @apply h-full transition-all duration-500 ease-out;
      }
      .level-badge {
        @apply inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800;
      }
      .reward-card {
        @apply bg-gradient-to-br from-yellow-100 to-orange-100 rounded-xl p-4 border border-yellow-200 shadow-lg transition-all duration-500 animate-fade-in;
      }
      .listening {
        background-color: #ef4444 !important;
      }
      #similarityMeter {
        transition: all 0.3s ease;
      }
      .word-input.highlight {
        animation: highlight 1s ease;
      }
      /* 移动端按钮布局优化 */
      .btn-group {
        @apply grid grid-cols-2 gap-2 sm:flex sm:gap-2;
      }
      .btn-group .game-btn {
        @apply flex-1 justify-center;
      }
      /* 选择器容器样式 */
      .selector-container {
        @apply grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4;
      }
      .form-selector {
        @apply flex flex-col space-y-1;
      }
      .select-wrapper {
        @apply relative;
      }
      .select-wrapper::after {
        content: "▼";
        @apply absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none;
      }
      .custom-select {
        @apply w-full px-4 py-2.5 rounded-lg border border-gray-300 bg-white appearance-none focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all;
      }
      .stats-badge {
        @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800;
      }
      .reward-card {
        @apply bg-gradient-to-br from-yellow-100 to-orange-100 rounded-xl p-4 border border-yellow-200 shadow-lg transition-all duration-500 animate-fade-in;
      }
      .listening {
        background-color: #ef4444 !important;
      }
      #similarityMeter {
        transition: all 0.3s ease;
      }
      .word-input.highlight {
        animation: highlight 1s ease;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen font-sans">
  <div class="max-w-3xl mx-auto px-4 py-6 sm:py-8">
    <!-- 游戏标题 -->
    <div class="text-center mb-6 sm:mb-8 animate-fade-in">
      <h1 class="text-[clamp(1.8rem,5vw,3rem)] font-bold text-gray-800 mb-2">
        <i class="fa fa-book text-primary mr-2"></i>单词拼写游戏
      </h1>
      <p class="text-gray-600 text-base sm:text-lg">提升你的英语词汇量！</p>
    </div>


    <!-- 游戏主容器 -->
    <div class="bg-white rounded-xl p-5 sm:p-6 shadow-lg mb-6 animate-fade-in">
      <!-- 文件和课时选择区域 -->
      <div class="mb-5 pb-4 border-b border-gray-100">
        <!-- 选择器容器 - 移动端垂直排列，桌面端横向排列 -->
        <div class="selector-container">
          <!-- 单词库选择 -->
          <div class="form-selector">
            <label class="block text-sm font-medium text-gray-700">选择单词文件：</label>
            <div class="select-wrapper">
              <select id="wordFileSelect" class="custom-select">
                <option value="default">默认单词库</option>
                <option value="threesh">三年级上单词</option>
                <option value="basic">新概念1词库</option>
              </select>
            </div>
          </div>
          
          <!-- 课时选择 -->
          <div class="form-selector">
            <label class="block text-sm font-medium text-gray-700">选择课时：</label>
            <div class="select-wrapper">
              <select id="lessonSelect" class="custom-select">
                <option value="">请先选择单词库</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- 操作按钮区域 -->
        <div class="flex flex-wrap gap-2 mb-2">
          <!-- 课时统计信息 -->
          <div id="lessonStats" class="flex-1 flex items-center justify-center sm:justify-end text-sm text-gray-600">
            <span id="statsInfo" class="hidden sm:inline-flex items-center">
              <i class="fa fa-book text-primary mr-1"></i>
              <span>总课时：--</span>
              <span class="mx-2">|</span>
              <span>总单词：--</span>
            </span>
          </div>
        </div>
        
        <!-- 加载状态提示 -->
        <div id="fileNotification" class="mt-1 text-sm text-gray-600"></div>
      </div>


      <!-- 游戏内容区域 -->
      <div id="content" class="space-y-5">
        <!-- 关卡和题目信息 -->
        <div class="animate-slide-up">
          <div id="instruction" class="text-lg font-semibold text-gray-800 mb-1"></div>
          <div id="stats" class="flex flex-wrap gap-2 text-sm text-gray-600"></div>
        </div>


        <!-- 单词信息 -->
        <div class="bg-blue-50 rounded-lg p-4 mb-5 animate-slide-up" style="animation-delay: 0.1s">
          <div id="question" class="text-base font-medium text-gray-800 mb-2"></div>
          <div id="definition" class="text-lg text-primary font-medium mb-1"></div>
          <div id="phonetic" class="text-base text-indigo-500 italic"></div>
        </div>


        <!-- 单词输入区域 -->
        <div class="flex justify-center mb-5 animate-slide-up" style="animation-delay: 0.2s">
          <div id="letterBox" class="flex gap-2 flex-wrap justify-center"></div>
        </div>


        <!-- 操作按钮 - 移动端优化布局 -->
        <div class="mb-5 animate-slide-up" style="animation-delay: 0.3s">
          <div class="btn-group mb-2">
            <button onclick="prevQuestion()" id="prevBtn" class="game-btn bg-gray-200 text-gray-700 focus:ring-gray-400">
              <i class="fa fa-arrow-left mr-1"></i> 上一题
            </button>
            <button onclick="toggleListening()" id="startReadingBtn" class="game-btn bg-orange-500 text-white focus:ring-orange-500">
              <i class="fa fa-microphone mr-1"></i> 开始朗读
            </button>
          </div>
          <div class="btn-group">
            <button onclick="readWord()" class="game-btn bg-primary text-white focus:ring-primary">
              <i class="fa fa-volume-up mr-1"></i> 听单词
            </button>
            <button onclick="showMistakes()" class="game-btn bg-green-500 text-white focus:ring-green-500">
              <i class="fa fa-book mr-1"></i> 查看错题本
            </button>
          </div>
          <div class="btn-group mt-2">
            <button onclick="submitAnswer()" id="nextBtn" class="game-btn bg-gray-200 text-gray-700 focus:ring-gray-400">
              跳过此题 <i class="fa fa-arrow-right ml-1"></i>
            </button>
            <button onclick="resetProgress()" class="game-btn bg-gray-200 text-gray-700 focus:ring-gray-400 flex-1 sm:flex-none min-w-[120px]">
              <i class="fa fa-refresh mr-1"></i> 重置进度
            </button>
            <button onclick="exitReview()" class="game-btn bg-green-500 text-white focus:ring-green-500" style="display:none">
              <i class="fa fa-arrow-left mr-1"></i> 返回闯关
            </button>
            <button onclick="nextQuestion()" id="continueBtn" class="game-btn bg-secondary text-white focus:ring-secondary" style="display:none">
              <i class="fa fa-arrow-right mr-1"></i> 继续下一题
            </button>
          </div>
        </div>


        <!-- 相似度指示器 -->
        <div id="similarityMeter" class="progress-bar mb-5 animate-slide-up" style="animation-delay: 0.4s; display: none">
          <div class="progress-fill bg-primary" id="similarityFill"></div>
        </div>


        <!-- 选项区域 -->
        <div id="options" class="space-y-2 animate-slide-up" style="animation-delay: 0.5s"></div>


        <!-- 结果区域 -->
        <div id="result" class="mt-4 p-4 rounded-lg text-center font-medium animate-slide-up" style="animation-delay: 0.6s"></div>


        <!-- 连续正确奖励区域 -->
        <div id="streakReward" class="hidden reward-card mt-5">
          <h3 class="font-bold text-lg text-orange-600 mb-2">连续正确奖励!</h3>
          <p id="rewardMessage" class="text-gray-700 mb-3"></p>
          <div class="flex justify-center">
            <button onclick="claimReward()" class="game-btn bg-orange-500 text-white focus:ring-orange-500">
              <i class="fa fa-gift mr-1"></i> 领取奖励
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- 底部信息 -->
    <div class="text-center text-gray-500 text-sm mt-6 animate-fade-in">
      <p>单词拼写游戏 V3.4 ©___在路上 | 系统学习英语词汇</p>
    </div>
  </div>


  <!-- 音频元素 -->
  <audio id="bgm" autoplay loop>
    <source src="https://cdn.pixabay.com/audio/2022/10/30/audio_46fdd201cc.mp3" type="audio/mpeg">
  </audio>
  <audio id="correct-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_e0b6f67a53.mp3"></audio>
  <audio id="wrong-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_2307f9b816.mp3"></audio>
  <audio id="reward-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_139c839a53.mp3"></audio>


  <!-- 连续正确提示 -->
  <div id="streakEffect" class="streak-effect"></div>


  <script>
    // API配置 - 请替换为您自己的密钥
    const API_CONFIG = {
      oxford: {
        appId: "be22b666",       // 牛津词典API ID
        appKey: "b6444886a80bdc60359c3584510e44ee",     // 牛津词典API密钥
        baseUrl: "https://od-api-sandbox.oxforddictionaries.com/api/v2"
      },
      forvo: {
        apiKey: "YOUR_FORVO_API_KEY",      // Forvo API密钥
        baseUrl: "https://apifree.forvo.com/api"
      }
    };


    // 按课时组织的核心单词库
    const lessonWordLists = {
      "default": {
        name: "默认单词库",
        lessons: [
          {
            id: 1,
            name: "第1课：时间词汇",
            words: [
              {word:"morning", definition:"早晨；上午", phonetic:"/ˈmɔːnɪŋ/"},
              {word:"afternoon", definition:"午后；下午", phonetic:"/ˌɑːftəˈnuːn/"},
              {word:"evening", definition:"晚上；傍晚", phonetic:"/ˈiːvnɪŋ/"},
              {word:"night", definition:"夜间；夜晚", phonetic:"/naɪt/"},
              {word:"today", definition:"今天", phonetic:"/təˈdeɪ/"},
            ]
          },
          {
            id: 2,
            name: "第2课：日常用语",
            words: [
              {word:"fine", definition:"好的", phonetic:"/faɪn/"},
              {word:"thank", definition:"感谢", phonetic:"/θæŋk/"},
              {word:"goodbye", definition:"再见", phonetic:"/ˌɡʊdˈbaɪ/"},
              {word:"day", definition:"一天", phonetic:"/deɪ/"},
              {word:"hello", definition:"你好", phonetic:"/həˈləʊ/"},
            ]
          },
          {
            id: 3,
            name: "第3课：人物称呼",
            words: [
              {word:"Mrs", definition:"夫人；太太", phonetic:"/ˈmɪsɪz/"},
              {word:"Mr", definition:"先生", phonetic:"/ˈmɪstə(r)/"},
              {word:"Miss", definition:"小姐", phonetic:"/mɪs/"},
              {word:"friend", definition:"朋友", phonetic:"/frend/"},
              {word:"teacher", definition:"老师", phonetic:"/ˈtiːtʃə(r)/"},
            ]
          }
        ],
        isCustom: false,
        loaded: true
      },
       "threesh": {
        name: "三年级上单词",
        lessons: [],
        isCustom: true,
        loaded: false
      },
      "basic": {
        name: "新概念1词库",
        lessons: [],
        isCustom: true,
        loaded: false
      }
    };


    // 关卡谜题
    const puzzleQuestions = [
      { question: "“日出大米”猜一个字？", options: ["明", "昌", "早", "亮"], answer: "昌" },
      { question: "什么东西越洗越脏？", options: ["衣服", "手", "水", "地板"], answer: "水" },
      { question: "哪种狗不会叫？", options: ["热狗", "藏獒", "哈士奇", "牧羊犬"], answer: "热狗" },
      { question: "“一加一”猜一个字？", options: ["二", "十", "王", "丰"], answer: "王" },
      { question: "什么东西有五个头，但人不觉得它怪？", options: ["手指", "蛇", "海星", "石头"], answer: "手指" },
      { question: "什么球不能踢？", options: ["足球", "地球", "篮球", "排球"], answer: "地球" },
      { question: "“一点一横长，一撇到南洋”猜一个字？", options: ["大", "天", "广", "厂"], answer: "广" },
      { question: "什么东西晚上才会长出尾巴？", options: ["流星", "月亮", "壁虎", "影子"], answer: "流星" },
      { question: "什么水果视力最差？", options: ["苹果", "香蕉", "芒果", "葡萄"], answer: "芒果" },
      { question: "“三人同日来，喜见百花开”猜一个字？", options: ["春", "众", "晶", "森"], answer: "春" },
      { question: "什么东西越用越有钱？", options: ["钱包", "存钱罐", "银行卡", "聚宝盆"], answer: "存钱罐" },
      { question: "哪种鸡没有翅膀？", options: ["肉鸡", "田鸡", "野鸡", "火鸡"], answer: "田鸡" },
      { question: "“一边红，一边绿，一边喜雨，一边喜风”猜一个字？", options: ["秋", "明", "晴", "吵"], answer: "秋" },
      { question: "什么东西有腿却不能走路？", options: ["桌子", "狗", "蛇", "鱼"], answer: "桌子" },
      { question: "什么伞下雨天不能用？", options: ["太阳伞", "降落伞", "雨伞", "油纸伞"], answer: "降落伞" },
      { question: "“十字对十字，太阳对月亮”猜一个字？", options: ["朝", "萌", "冒", "明"], answer: "朝" },
      { question: "什么东西见者有份？", options: ["阳光", "礼物", "空气", "风景"], answer: "阳光" },
      { question: "什么马不会跑？", options: ["木马", "斑马", "河马", "宝马"], answer: "木马" },
      { question: "“有心走不快，见水装不完，长草难收拾”猜一个字？", options: ["曼", "慢", "漫", "蔓"], answer: "曼" },
      { question: "什么东西越剪越长？", options: ["绳子", "头发", "布料", "指甲"], answer: "头发" },
      { question: "什么瓜不能吃？", options: ["西瓜", "黄瓜", "傻瓜", "冬瓜"], answer: "傻瓜" },
      { question: "“有头无颈，有眼无眉”猜一种动物？", options: ["鱼", "蛇", "青蛙", "蚯蚓"], answer: "鱼" },
      { question: "什么东西能载万吨货物，却载不动一粒沙子？", options: ["船", "车", "飞机", "水"], answer: "水" },
      { question: "什么书你不可能在书店买到？", options: ["漫画书", "遗书", "故事书", "教科书"], answer: "遗书" },
      { question: "“七十二小时”猜一个字？", options: ["晶", "明", "早", "旭"], answer: "晶" },
      { question: "什么东西天气越热，它爬得越高？", options: ["温度计", "太阳", "气球", "冰淇淋"], answer: "温度计" },
      { question: "什么笔不能写字？", options: ["毛笔", "钢笔", "电笔", "铅笔"], answer: "电笔" },
      { question: "“一加一不是二”猜一个字？", options: ["王", "丰", "田", "由"], answer: "王" },
      { question: "什么东西别人请你吃，但你自己还要付钱？", options: ["官司", "饭局", "零食", "早餐"], answer: "官司" },
      { question: "什么牛不吃草？", options: ["水牛", "黄牛", "蜗牛", "奶牛"], answer: "蜗牛" },
      { question: "什么东西越擦越黑？", options: ["黑板", "镜子", "皮鞋", "玻璃"], answer: "黑板" },
      { question: "什么球离你最近？", options: ["足球", "地球", "眼球", "气球"], answer: "眼球" },
      { question: "“一人一张口，下面长只手”猜一个字？", options: ["拿", "合", "哈", "答"], answer: "拿" },
      { question: "什么东西没脚走天下？", options: ["船", "蛇", "路", "邮票"], answer: "邮票" },
      {question: "什么东西越洗越脏？", options: ["衣服", "手", "水", "地板"], answer: "水"}
    ];


    // 奖励谜题（连续答对5题时使用）
    const rewardPuzzles = [
      { question: "什么水果有视力问题？", options: ["苹果", "香蕉", "芒果", "葡萄"], answer: "芒果" },
      { question: "什么东西有头无颈？", options: ["酒瓶", "铅笔", "石头", "桌子"], answer: "酒瓶" },
      { question: "什么东西人们在不停地吃它，却永远吃不饱？", options: ["空气", "水", "零食", "知识"], answer: "空气" },
      { question: "什么东西能加不能减？", options: ["年龄", "体重", "金钱", "分数"], answer: "年龄" },
      { question: "什么东西越生气，它就越大？", options: ["脾气", "气球", "火焰", "海浪"], answer: "脾气" }
    ];


    // 发音变体（用于容错）
    const pronunciationVariants = {
      "morning": ["mornin", "mornning"],
      "afternoon": ["afternun", "afternooon"],
      "evening": ["evenin", "evenning"],
      "hello": ["hallo", "hellow"],
    };


    // 连续正确奖励配置
    const streakRewards = {
      5: {
        description: "挑战奖励谜题赢取额外积分！",
        action: () => {
          // 触发奖励谜题
          showRewardPuzzle();
          return "完成谜题获得额外奖励！";
        }
      }
    };


    // 初始化游戏数据结构 - 按单词库独立保存
    const defaultGameData = {
      // 每个单词库的独立数据
      "default": {
        currentLessonId: 1,
        currentIndex: 0,
        lessonStars: {},
        wrongList: [],
        puzzleQuestionsUsed: []
      },
      "threesh": {
        currentLessonId: 1,
        currentIndex: 0,
        lessonStars: {},
        wrongList: [],
        puzzleQuestionsUsed: []
      },
      "basic": {
        currentLessonId: 1,
        currentIndex: 0,
        lessonStars: {},
        wrongList: [],
        puzzleQuestionsUsed: []
      }
    };

    // 从localStorage加载数据，合并默认值
    let allGameData = JSON.parse(localStorage.getItem('wordGameData')) || {};
    // 合并默认数据结构，确保所有单词库都有基础数据
    Object.keys(defaultGameData).forEach(file => {
      if (!allGameData[file]) {
        allGameData[file] = {...defaultGameData[file]};
      }
    });

    // 当前活动的单词库
    let currentFile = "default";
    // 从当前单词库数据初始化变量
    let {
      currentLessonId,
      currentIndex,
      lessonStars,
      wrongList,
      puzzleQuestionsUsed
    } = allGameData[currentFile];


    // 其他游戏状态变量
    let inPuzzle = false;
    let inRewardPuzzle = false;
    let isReviewMode = false;
    let currentStreak = 0;
    let currentReviewIndex = 0;
    let recognition;
    let isListening = false;
    let answerCorrect = false;
    let speechSynthAvailable = false;
    let rewardPuzzleIndex = -1;


    // DOM元素缓存
    const dom = {
      instruction: document.getElementById("instruction"),
      question: document.getElementById("question"),
      result: document.getElementById("result"),
      options: document.getElementById("options"),
      definition: document.getElementById("definition"),
      phonetic: document.getElementById("phonetic"),
      letterBox: document.getElementById("letterBox"),
      stats: document.getElementById("stats"),
      nextBtn: document.getElementById("nextBtn"),
      prevBtn: document.getElementById("prevBtn"),
      startReadingBtn: document.getElementById("startReadingBtn"),
      fileNotification: document.getElementById("fileNotification"),
      similarityMeter: document.getElementById("similarityMeter"),
      similarityFill: document.getElementById("similarityFill"),
      streakReward: document.getElementById("streakReward"),
      rewardMessage: document.getElementById("rewardMessage"),
      correctSound: document.getElementById("correct-sound"),
      wrongSound: document.getElementById("wrong-sound"),
      rewardSound: document.getElementById("reward-sound"),
      readWordBtn: document.querySelector('button[onclick="readWord()"]'),
      lessonSelect: document.getElementById("lessonSelect"),
      wordFileSelect: document.getElementById("wordFileSelect")
    };


    // 检查语音服务支持情况
    function checkSpeechServices() {
      // 检查API密钥是否配置
      const hasOxfordKeys = API_CONFIG.oxford.appId && API_CONFIG.oxford.appKey;
      const hasForvoKey = API_CONFIG.forvo.apiKey;
      
      if (!hasOxfordKeys && !hasForvoKey) {
        dom.readWordBtn.disabled = true;
        dom.readWordBtn.title = "请配置API密钥以使用发音功能";
        return false;
      }
      
      dom.readWordBtn.disabled = false;
      return true;
    }


    // 牛津词典API获取发音
    async function getOxfordPronunciation(word) {
      try {
        const url = `${API_CONFIG.oxford.baseUrl}/entries/en-us/${encodeURIComponent(word)}?fields=pronunciations`;
        
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'app_id': API_CONFIG.oxford.appId,
            'app_key': API_CONFIG.oxford.appKey
          }
        });
        
        if (!response.ok) {
          throw new Error(`Oxford API error: ${response.status}`);
        }
        
        const data = await response.json();
        
        // 提取发音URL (优先选择音频)
        if (data.results && data.results.length > 0 && 
            data.results[0].lexicalEntries && 
            data.results[0].lexicalEntries[0].entries &&
            data.results[0].lexicalEntries[0].entries[0].pronunciations) {
              
            const pronunciations = data.results[0].lexicalEntries[0].entries[0].pronunciations;
            // 查找美式发音的音频URL
            const audioPron = pronunciations.find(p => 
              p.dialects && p.dialects.includes('American English') && p.audioFile
            );
            
            if (audioPron && audioPron.audioFile) {
              return audioPron.audioFile;
            }
        }
        
        // 未找到发音
        throw new Error("No pronunciation found in Oxford API");
      } catch (error) {
        console.error("Oxford API error:", error);
        return null;
      }
    }


    // Forvo API获取发音
    async function getForvoPronunciation(word) {
      try {
        const url = `${API_CONFIG.forvo.baseUrl}/word/${encodeURIComponent(word)}/en-us/?key=${API_CONFIG.forvo.apiKey}&format=json&limit=1`;
        
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`Forvo API error: ${response.status}`);
        }
        
        const data = await response.json();
        
        // 提取发音URL
        if (data.items && data.items.length > 0 && data.items[0].pathmp3) {
          return data.items[0].pathmp3;
        }
        
        throw new Error("No pronunciation found in Forvo API");
      } catch (error) {
        console.error("Forvo API error:", error);
        return null;
      }
    }


    // 播放单词发音 (优先使用Oxford，失败则使用Forvo)
    async function readWord() {
      if (!checkSpeechServices()) return;
      
      // 获取当前单词
      const currentWord = isReviewMode 
        ? wrongList[currentReviewIndex].word
        : getCurrentLesson().words[currentIndex].word;
      
      // 显示加载状态
      dom.readWordBtn.disabled = true;
      dom.readWordBtn.textContent = "加载发音中...";
      dom.result.textContent = `正在加载 "${currentWord}" 的发音...`;
      
      try {
        let audioUrl = null;
        
        // 1. 尝试从Oxford API获取发音
        if (API_CONFIG.oxford.appId && API_CONFIG.oxford.appKey) {
          audioUrl = await getOxfordPronunciation(currentWord);
        }
        
        // 2. 如果Oxford失败，尝试Forvo API
        if (!audioUrl && API_CONFIG.forvo.apiKey) {
          audioUrl = await getForvoPronunciation(currentWord);
        }
        
        // 3. 播放发音
        if (audioUrl) {
          // 创建音频元素播放
          const audio = new Audio(audioUrl);
          
          audio.onplay = () => {
            dom.result.textContent = `正在播放 "${currentWord}" 的发音...`;
          };
          
          audio.onended = () => {
            dom.result.textContent = `已播放 "${currentWord}" 的发音`;
            resetReadButton();
          };
          
          audio.onerror = (error) => {
            throw new Error(`音频播放失败: ${error.message}`);
          };
          
          audio.play();
        } else {
          throw new Error("无法获取单词发音");
        }
      } catch (error) {
        console.error("发音错误:", error);
        dom.result.textContent = `获取发音失败: ${error.message}`;
        resetReadButton();
      }
    }


    // 重置发音按钮状态
    function resetReadButton() {
      dom.readWordBtn.disabled
